<html lang="en"><head>
    <meta charset="UTF-8">
    <title>Sales Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style type="text/tailwindcss">
      @theme {
        --color-primary: #0F766E;
        --color-primary-hover: #0D9488;
        --color-secondary: #475569;
        --color-accent: #D97706;
        --color-background: #F8FAFC;
        --color-surface: #FFFFFF;
        --color-surface-variant: #F1F5F9;
        --color-on-background: #0F172A;
        --color-on-surface: #1E293B;
        --color-border: #E2E8F0;
        --color-success: #16A34A;
        --color-warning: #F59E0B;
        --color-error: #DC2626;
        --color-info: #2563EB;
        --header-height: 4rem;
        --sidebar-width: 16rem;
      }

      html {
        scroll-behavior: smooth;
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .app-header {
        height: var(--header-height);
      }
      .app-sidebar {
        top: var(--header-height);
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
      }
      .app-main {
        margin-top: var(--header-height);
        min-height: calc(100vh - var(--header-height));
      }
      @media (min-width: 768px) {
        .app-main {
          margin-left: var(--sidebar-width);
        }
      }

      @media (max-width: 767px) {
        .app-sidebar {
          left: calc(-1 * var(--sidebar-width));
          transition: left 0.3s ease-in-out;
        }
        .app-sidebar.open {
          left: 0;
        }
      }

      .nav-link.active {
        border-left: 3px solid var(--color-primary);
        padding-left: calc(1rem - 3px);
      }

      .popover {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out,
          visibility 0.2s ease-in-out;
      }
      .popover.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .sidebar-backdrop {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .sidebar-backdrop.active {
        opacity: 1;
        visibility: visible;
      }
    </style>
  <title>Staff Performance Analysis - Sales Analytics Dashboard</title></head>
  <body class="bg-slate-50 text-slate-800 overflow-x-hidden">
    <header class="app-header fixed top-0 left-0 right-0 bg-white border-b border-slate-200 z-40">
      <div class="h-full max-w-[1920px] mx-auto px-4 md:px-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <button id="mobileMenuToggle" class="flex items-center justify-center w-10 h-10 rounded text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition-all duration-200 cursor-pointer border-0 bg-transparent md:hidden focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="Toggle navigation menu" aria-expanded="false">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>

          <div class="flex items-center gap-3">
            <div class="w-8 h-8 flex items-center justify-center">
              <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="68" y="68" width="264" height="264" rx="32" stroke="#0F766E" stroke-width="18"></rect>
                <rect x="109" y="143" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="143" width="71" height="33" rx="8" fill="#D97706"></rect>
                <rect x="206" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
              </svg>
            </div>
            <h1 class="text-lg md:text-xl font-bold text-slate-900">Sales Analytics Dashboard</h1>
          </div>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
          <button id="userProfileButton" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-transparent hover:bg-slate-50 hover:border-slate-200 transition-all duration-200 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="User profile menu" aria-expanded="false" aria-haspopup="true">
            <div id="userAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
            <div class="hidden sm:flex flex-col items-start">
              <div id="userName" class="text-sm font-medium text-slate-900"></div>
            </div>
            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 hidden sm:block"></i>
          </button>
        </div>
      </div>
    </header>

    <div id="userProfilePopover" class="popover absolute top-[4.5rem] right-4 md:right-6 w-72 bg-white border border-slate-200 rounded-lg shadow-xl z-50" role="dialog" aria-labelledby="popoverUserName" data-portal="body">
      <div class="p-4">
        <div class="flex items-center gap-3 pb-3 mb-3 border-b border-slate-100">
          <div id="popoverUserAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div id="popoverUserName" class="font-semibold text-slate-900 truncate"></div>
            <div id="popoverUserEmail" class="text-xs text-slate-600 truncate"></div>
          </div>
        </div>

        <div class="space-y-1">
          <button id="signOutButton" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-md transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            Sign Out
          </button>
        </div>
      </div>
    </div>

    <div id="sidebarBackdrop" class="sidebar-backdrop fixed inset-0 bg-black/50 z-20 md:hidden" style="top: var(--header-height)"></div>

    <aside id="sidebar" class="app-sidebar fixed left-0 bg-white border-r border-slate-200 overflow-y-auto z-30 transition-transform duration-300 ease-in-out">
      <nav class="p-4" role="navigation" aria-label="Main navigation">
        <div class="py-6 border-b border-slate-100 first:pt-0 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Analytics</div>
          <div class="space-y-1">
            <a href="dashboard.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline active bg-teal-50 text-teal-700" data-page="dashboard">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a href="sku_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="sku_performance">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>SKU Performance</span>
            </a>
            <a href="store_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="store_performance">
              <i data-lucide="store" class="w-5 h-5"></i>
              <span>Store Performance</span>
            </a>
            <a href="staff_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="staff_performance">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Staff Performance</span>
            </a>
            <a href="transaction_history.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="transaction_history">
              <i data-lucide="receipt" class="w-5 h-5"></i>
              <span>Transaction History</span>
            </a>
          </div>
        </div>

        <div class="py-6 border-b border-slate-100 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Tools</div>
          <div class="space-y-1">
            <a href="reports_configuration.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="reports">
              <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
              <span>Reports</span>
            </a>
            <a href="settings.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
              <span>Settings</span>
            </a>
          </div>
        </div>
      </nav>
    </aside>

    <main class="app-main p-6" id="pageContent" role="main"><div class="mb-6">
  <nav aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm text-slate-600">
      <li>
        <a href="dashboard.html" class="hover:text-teal-700 transition-colors">Dashboard</a>
      </li>
      <li>
        <i data-lucide="chevron-right" class="w-4 h-4"></i>
      </li>
      <li class="text-slate-900 font-medium">Staff Performance</li>
    </ol>
  </nav>
</div>

<!-- Page Header -->
<div class="mb-8">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div>
      <h1 class="text-[1.75rem] leading-[2.25rem] font-bold text-slate-900">Staff Performance Analysis</h1>
      <p class="text-sm leading-[1.375rem] text-slate-600 mt-1">Analyze and compare staff-level sales recording activity</p>
    </div>
    
    <div class="flex items-center gap-3">
      <button id="exportButton" class="flex items-center gap-2 px-4 py-2 bg-teal-700 text-white text-sm font-semibold rounded-lg hover:bg-teal-600 focus:outline-none focus:ring-2 focus:ring-teal-700 focus:ring-offset-2 transition-colors">
        <i data-lucide="download" class="w-4 h-4"></i>
        Export
      </button>
    </div>
  </div>
</div>

<!-- Filters and Search -->
<div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
  <!-- Left Sidebar Filters -->
  <div class="lg:col-span-1">
    <div class="bg-white rounded-lg border border-slate-200 p-4">
      <h3 class="text-base leading-6 font-semibold text-slate-800 mb-4">Filters</h3>
      
      <!-- Role Filter -->
      <div class="mb-4">
        <label class="text-sm font-medium text-slate-700 mb-2 block">Role</label>
        <div class="space-y-2">
          <label class="flex items-center">
            <input type="checkbox" id="rolePromodizer" class="rounded border-slate-300 text-teal-700 focus:ring-teal-700" checked="">
            <span class="ml-2 text-sm text-slate-700">Promodizer</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" id="roleSupervisor" class="rounded border-slate-300 text-teal-700 focus:ring-teal-700" checked="">
            <span class="ml-2 text-sm text-slate-700">Supervisor</span>
          </label>
        </div>
      </div>

      <!-- Date Range Filter -->
      <div class="mb-4">
        <label class="text-sm font-medium text-slate-700 mb-2 block">Date Range</label>
        <div class="space-y-2">
          <input type="date" id="dateStart" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-700 focus:border-teal-700">
          <input type="date" id="dateEnd" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-700 focus:border-teal-700">
        </div>
      </div>

      <!-- Activity Level Range -->
      <div class="mb-4">
        <label class="text-sm font-medium text-slate-700 mb-2 block">Transactions per Day</label>
        <div class="space-y-2">
          <input type="range" id="activityMin" min="0" max="20" value="0" class="w-full">
          <div class="flex justify-between text-xs text-slate-600">
            <span id="activityMinValue">0</span>
            <span id="activityMaxValue">20+</span>
          </div>
        </div>
      </div>

      <!-- Assigned Store Filter -->
      <div class="mb-6">
        <label class="text-sm font-medium text-slate-700 mb-2 block">Assigned Stores</label>
        <select id="storeFilter" multiple="" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-700 focus:border-teal-700" size="4">
        </select>
      </div>

      <!-- Filter Actions -->
      <div class="space-y-2">
        <button id="applyFilters" class="w-full px-4 py-2 bg-teal-700 text-white text-sm font-semibold rounded hover:bg-teal-600 transition-colors">
          Apply Filters
        </button>
        <button id="clearFilters" class="w-full px-4 py-2 bg-slate-100 text-slate-700 text-sm font-semibold rounded hover:bg-slate-200 transition-colors">
          Clear All
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Area -->
  <div class="lg:col-span-3">
    <!-- Search and Active Filters -->
    <div class="bg-white rounded-lg border border-slate-200 p-4 mb-4">
      <!-- Search Bar -->
      <div class="mb-4">
        <div class="relative">
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <i data-lucide="search" class="w-4 h-4 text-slate-400"></i>
          </div>
          <input type="text" id="searchInput" placeholder="Search by Employee ID, Name, or Email..." class="block w-full pl-10 pr-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-teal-700 focus:border-teal-700">
        </div>
      </div>

      <!-- Active Filters Tags -->
      <div id="activeFilters" class="flex flex-wrap gap-2"></div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden">
      <div class="bg-white rounded-lg border border-slate-200 p-8 text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-teal-700"></div>
        <p class="text-slate-600 mt-2">Loading staff performance data...</p>
      </div>
    </div>

    <!-- Staff Performance Table -->
    <div id="staffTableContainer" class="bg-white rounded-lg border border-slate-200 overflow-hidden">
      <!-- Table Header -->
      <div class="px-6 py-4 border-b border-slate-200">
        <div class="flex justify-between items-center">
          <h3 class="text-base font-semibold text-slate-900">Staff Performance</h3>
          <span id="staffCount" class="text-sm text-slate-600"></span>
        </div>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="employeeId">
                  Employee ID
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="name">
                  Staff Name
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="role">
                  Role
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="storesCount">
                  Assigned Stores
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="totalQuantity">
                  Total Quantity
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="totalTransactions">
                  Total Transactions
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="daysActive">
                  Days Active
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="avgTransPerDay">
                  Avg Trans/Day
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
              <th class="px-6 py-3 text-left">
                <button class="flex items-center gap-1 text-xs font-semibold uppercase tracking-wider text-slate-600 hover:text-slate-900" data-sort="lastActivity">
                  Last Activity
                  <i data-lucide="chevron-up-down" class="w-3 h-3"></i>
                </button>
              </th>
            </tr>
          </thead>
          <tbody id="staffTableBody" class="divide-y divide-slate-200">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>

      <!-- Empty State -->
      <div id="emptyState" class="hidden p-8 text-center">
        <div class="w-12 h-12 mx-auto mb-4 text-slate-400">
          <i data-lucide="users" class="w-12 h-12"></i>
        </div>
        <h3 class="text-base font-semibold text-slate-900 mb-2">No Staff Found</h3>
        <p class="text-sm text-slate-600 mb-4">No staff members match your current filters.</p>
        <button id="clearFiltersFromEmpty" class="px-4 py-2 bg-teal-700 text-white text-sm font-semibold rounded hover:bg-teal-600 transition-colors">
          Clear Filters
        </button>
      </div>
    </div>

    <!-- Pagination -->
    <div id="pagination" class="mt-6 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-sm text-slate-600">Showing</span>
        <span id="paginationInfo" class="text-sm font-medium text-slate-900"></span>
        <span class="text-sm text-slate-600">staff members</span>
      </div>
      <div class="flex items-center gap-2">
        <button id="prevPage" class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed" disabled="">
          Previous
        </button>
        <div id="pageNumbers" class="flex items-center gap-1"></div>
        <button id="nextPage" class="px-3 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-200 rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed">
          Next
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div id="exportModal" data-portal="body" class="fixed inset-0 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4 bg-black/50">
    <div class="bg-white rounded-xl shadow-xl w-[min(92vw,32rem)] max-h-[90vh] overflow-y-auto">
      <div class="px-6 py-4 border-b border-slate-200">
        <h3 class="text-base font-semibold text-slate-900">Export Staff Performance Data</h3>
      </div>
      
      <div class="px-6 py-4">
        <!-- Export Format -->
        <div class="mb-4">
          <label class="text-sm font-medium text-slate-700 mb-3 block">Export Format</label>
          <div class="space-y-3">
            <label class="flex items-center p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="exportFormat" value="csv" class="text-teal-700 focus:ring-teal-700" checked="">
              <div class="ml-3">
                <div class="text-sm font-medium text-slate-900">CSV Format</div>
                <div class="text-xs text-slate-600">Comma-separated values for spreadsheet applications</div>
              </div>
            </label>
            <label class="flex items-center p-3 border border-slate-200 rounded-lg hover:bg-slate-50 cursor-pointer">
              <input type="radio" name="exportFormat" value="json" class="text-teal-700 focus:ring-teal-700">
              <div class="ml-3">
                <div class="text-sm font-medium text-slate-900">JSON Format</div>
                <div class="text-xs text-slate-600">Structured data format for development use</div>
              </div>
            </label>
          </div>
        </div>

        <!-- File Name Preview -->
        <div class="mb-4">
          <label class="text-sm font-medium text-slate-700 mb-2 block">File Name</label>
          <div class="px-3 py-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-600">
            <span id="exportFileName">staff_performance_2024-12-19</span><span id="exportFileExt">.csv</span>
          </div>
        </div>

        <!-- Include Filtered Results -->
        <div class="mb-4">
          <label class="flex items-center">
            <input type="checkbox" id="exportFiltered" class="rounded border-slate-300 text-teal-700 focus:ring-teal-700" checked="">
            <span class="ml-2 text-sm text-slate-700">Include only filtered results</span>
          </label>
          <p id="exportCount" class="text-xs text-slate-600 mt-1"></p>
        </div>

        <!-- Error Message -->
        <div id="exportError" class="hidden p-3 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex">
            <i data-lucide="alert-circle" class="w-4 h-4 text-red-600 mt-0.5"></i>
            <div class="ml-2">
              <div class="text-sm font-medium text-red-800">Export Failed</div>
              <div class="text-sm text-red-700 mt-1">Please try again or contact support if the issue persists.</div>
            </div>
          </div>
          <button id="retryExport" class="mt-2 px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors">
            Retry
          </button>
        </div>
      </div>

      <div class="px-6 py-4 border-t border-slate-200 flex justify-end gap-3">
        <button id="cancelExport" class="px-4 py-2 text-sm font-medium text-slate-700 bg-slate-100 rounded hover:bg-slate-200 transition-colors">
          Cancel
        </button>
        <button id="confirmExport" class="px-4 py-2 text-sm font-medium text-white bg-teal-700 rounded hover:bg-teal-600 transition-colors">
          Export
        </button>
      </div>
    </div>
  </div>
</div>

</main>

    <script src="app.js"></script>
    <script src="app_data.js"></script>
    <script id="container-script">
      (function () {
        const TemplateUtils = (window.TemplateUtils = window.TemplateUtils || {});

        TemplateUtils.UserUtils =
          TemplateUtils.UserUtils ||
          (function createUserUtils() {
            return {
              getCurrentUser() {
                try {
                  let currentUserId = localStorage.getItem("currentUserId");
                  if (!currentUserId) {
                    localStorage.setItem("currentUserId", "usr_sales_001");
                    currentUserId = "usr_sales_001";
                  }

                  const users = JSON.parse(localStorage.getItem("users") || "[]");
                  return users.find(user => user.id === currentUserId) || null;
                } catch (error) {
                  console.error("Error retrieving user data:", error);
                  return null;
                }
              },
              signOut() {
                try {
                  localStorage.removeItem("currentUserId");
                  window.location.reload();
                } catch (error) {
                  console.error("Error signing out:", error);
                }
              },
              getUserDisplayName(user) {
                if (!user) return "Guest";
                return user.firstName && user.lastName
                  ? `${user.firstName} ${user.lastName}`
                  : user.firstName || user.lastName || "User";
              },
              getUserInitials(user) {
                if (!user) return "?";
                const first = user.firstName?.charAt(0) || "";
                const last = user.lastName?.charAt(0) || "";
                return (first + last).toUpperCase() || "U";
              },
            };
          })();

        if (TemplateUtils.__bootstrapped) {
          if (typeof window.lucide?.createIcons === "function") {
            window.lucide.createIcons();
          }
          return;
        }

        TemplateUtils.__bootstrapped = true;

        const state = {
          popoverVisible: false,
          sidebarOpen: false,
          resizeTimer: null,
          observerFrame: null,
          refs: {},
        };

        function ready(fn) {
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", fn, { once: true });
          } else if (typeof queueMicrotask === "function") {
            queueMicrotask(fn);
          } else {
            Promise.resolve().then(fn);
          }
        }

        function safeLucide(callback) {
          if (typeof window.lucide?.createIcons === "function") {
            callback();
          }
        }

        function cacheRefs() {
          state.refs = {
            userProfileButton: document.getElementById("userProfileButton"),
            userProfilePopover: document.getElementById("userProfilePopover"),
            userAvatar: document.getElementById("userAvatar"),
            userName: document.getElementById("userName"),
            popoverUserAvatar: document.getElementById("popoverUserAvatar"),
            popoverUserName: document.getElementById("popoverUserName"),
            popoverUserEmail: document.getElementById("popoverUserEmail"),
            signOutButton: document.getElementById("signOutButton"),
            mobileMenuToggle: document.getElementById("mobileMenuToggle"),
            sidebar: document.getElementById("sidebar"),
            sidebarBackdrop: document.getElementById("sidebarBackdrop"),
            navLinks: document.querySelectorAll(".nav-link"),
            pageContent: document.getElementById("pageContent"),
          };
        }

        function initializeUserProfile() {
          const { userAvatar, userName } = state.refs;
          if (!userAvatar || !userName) return;

          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          if (currentUser) {
            userAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            userName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
          } else {
            userAvatar.textContent = "?";
            userName.textContent = "Guest";
          }
        }

        function populatePopover() {
          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          const { popoverUserAvatar, popoverUserName, popoverUserEmail } = state.refs;
          if (!popoverUserAvatar || !popoverUserName || !popoverUserEmail) return;

          if (currentUser) {
            popoverUserAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            popoverUserName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
            popoverUserEmail.textContent = currentUser.email || "No email";
          } else {
            popoverUserAvatar.textContent = "?";
            popoverUserName.textContent = "Guest";
            popoverUserEmail.textContent = "Not logged in";
          }
        }

        function toggleUserPopover(forceClose = false) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (!userProfilePopover || !userProfileButton) return;

          const shouldOpen = forceClose ? false : !state.popoverVisible;
          if (shouldOpen) {
            populatePopover();
            userProfilePopover.classList.add("visible");
            userProfileButton.setAttribute("aria-expanded", "true");
            state.popoverVisible = true;
            const firstButton = userProfilePopover.querySelector("button");
            if (firstButton) {
              setTimeout(() => firstButton.focus(), 50);
            }
          } else {
            userProfilePopover.classList.remove("visible");
            userProfileButton.setAttribute("aria-expanded", "false");
            state.popoverVisible = false;
          }
        }

        function hideUserPopover() {
          if (state.popoverVisible) {
            toggleUserPopover(true);
          }
        }

        function toggleMobileSidebar(forceClose = false) {
          const { sidebar, sidebarBackdrop, mobileMenuToggle } = state.refs;
          if (!sidebar || !sidebarBackdrop || !mobileMenuToggle) return;

          const shouldOpen = forceClose ? false : !state.sidebarOpen;
          state.sidebarOpen = shouldOpen;

          sidebar.classList.toggle("open", shouldOpen);
          sidebarBackdrop.classList.toggle("active", shouldOpen);
          mobileMenuToggle.setAttribute("aria-expanded", shouldOpen ? "true" : "false");
          document.body.style.overflow = shouldOpen ? "hidden" : "";
        }

        function closeMobileSidebar() {
          if (state.sidebarOpen) {
            toggleMobileSidebar(true);
          }
        }

        function setActiveNavLink(pageId) {
          if (!pageId) return;
          const { navLinks } = state.refs;
          navLinks?.forEach((link) => {
            if (link.dataset.page === pageId) {
              link.classList.add("active", "bg-teal-50", "text-teal-700");
            } else {
              link.classList.remove("active", "bg-teal-50", "text-teal-700");
            }
          });
        }

        TemplateUtils.setActiveNavLink = setActiveNavLink;
        TemplateUtils.closeMobileSidebar = closeMobileSidebar;

        function handleDocumentClick(event) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (
            state.popoverVisible &&
            userProfilePopover &&
            userProfileButton &&
            !userProfilePopover.contains(event.target) &&
            !userProfileButton.contains(event.target)
          ) {
            hideUserPopover();
          }
        }

        function handleKeydown(event) {
          if (event.key !== "Escape") return;
          if (state.popoverVisible) {
            hideUserPopover();
            state.refs.userProfileButton?.focus();
          }
          if (state.sidebarOpen) {
            closeMobileSidebar();
            state.refs.mobileMenuToggle?.focus();
          }
        }

        function handleResize() {
          clearTimeout(state.resizeTimer);
          state.resizeTimer = setTimeout(() => {
            if (window.innerWidth >= 768) {
              closeMobileSidebar();
            }
          }, 200);
        }

        function bindEvents() {
          const {
            userProfileButton,
            mobileMenuToggle,
            sidebarBackdrop,
            signOutButton,
            navLinks,
          } = state.refs;

          userProfileButton?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleUserPopover();
          });

          mobileMenuToggle?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleMobileSidebar();
          });

          sidebarBackdrop?.addEventListener("click", () => closeMobileSidebar());

          signOutButton?.addEventListener("click", () => {
            if (confirm("Are you sure you want to sign out?")) {
              TemplateUtils.UserUtils.signOut();
            }
          });

          navLinks?.forEach((link) => {
            link.addEventListener("click", () => closeMobileSidebar());
          });

          document.addEventListener("click", handleDocumentClick);
          document.addEventListener("keydown", handleKeydown);
          window.addEventListener("resize", handleResize);
        }

        function initializePortalTargets() {
          document.querySelectorAll('[data-portal="body"]').forEach((node) => {
            if (node.parentElement !== document.body) {
              document.body.appendChild(node);
            }
          });
        }

        function observePageContent() {
          const { pageContent } = state.refs;
          if (!pageContent || typeof MutationObserver !== "function") return;

          const observer = new MutationObserver(() => {
            if (state.observerFrame) return;
            state.observerFrame = requestAnimationFrame(() => {
              state.observerFrame = null;
              safeLucide(() => window.lucide.createIcons());
            });
          });

          observer.observe(pageContent, { childList: true, subtree: true });
          state.observer = observer;
        }

        function bootstrap() {
          cacheRefs();
          initializePortalTargets();
          initializeUserProfile();
          bindEvents();
          safeLucide(() => window.lucide.createIcons());
          observePageContent();
        }

        ready(bootstrap);
      })();
    </script>
  

<script>
// Utility: portal a modal by id (idempotent)
function funPortalModalToBody(id){
  const el = document.getElementById(id);
  if (el && el.parentElement !== document.body) document.body.appendChild(el);
}

document.addEventListener('DOMContentLoaded', () => {
  // Auto-portal any modal declaring data-portal="body"
  document.querySelectorAll('[data-portal="body"]').forEach(el => {
    if (el.parentElement !== document.body) document.body.appendChild(el);
  });

  // Set active navigation
  if (window.TemplateUtils?.setActiveNavLink) {
    window.TemplateUtils.setActiveNavLink('staff_performance');
  }

  // Initialize the staff performance page
  const StaffPerformance = {
    data: {
      allStaff: [],
      filteredStaff: [],
      stores: new Map(),
      currentPage: 1,
      itemsPerPage: 50,
      sortColumn: 'totalQuantity',
      sortDirection: 'desc',
      filters: {
        search: '',
        roles: ['promodizer', 'supervisor'],
        dateStart: '',
        dateEnd: '',
        activityMin: 0,
        stores: []
      }
    },

    init() {
      this.loadData();
      this.setupEventListeners();
      this.populateFilters();
      this.applyFilters();
    },

    loadData() {
      try {
        const users = JSON.parse(localStorage.getItem('users') || '[]');
        const salesRecords = JSON.parse(localStorage.getItem('salesRecords') || '[]');
        const stores = JSON.parse(localStorage.getItem('stores') || '[]');
        const supervisorAllocations = JSON.parse(localStorage.getItem('supervisorAllocations') || '[]');
        const promodizerAllocations = JSON.parse(localStorage.getItem('promodizerAllocations') || '[]');

        // Create stores map
        stores.forEach(store => {
          this.data.stores.set(store.id, store);
        });

        // Filter staff users (promodizer and supervisor only)
        const staffUsers = users.filter(user => 
          ['promodizer', 'supervisor'].includes(user.role) && user.status === 'active'
        );

        // Calculate performance metrics for each staff member
        this.data.allStaff = staffUsers.map(user => {
          const userSalesRecords = salesRecords.filter(record => record.recordedById === user.id);
          
          // Calculate total quantity
          const totalQuantity = userSalesRecords.reduce((sum, record) => {
            return sum + record.scannedSkus.reduce((skuSum, sku) => skuSum + sku.quantity, 0);
          }, 0);

          // Calculate total transactions
          const totalTransactions = userSalesRecords.length;

          // Calculate days active
          const uniqueDates = new Set(
            userSalesRecords.map(record => record.recordedAt.split('T')[0])
          );
          const daysActive = uniqueDates.size;

          // Calculate average transactions per day
          const avgTransPerDay = daysActive > 0 ? (totalTransactions / daysActive).toFixed(1) : '0.0';

          // Find last activity date
          const lastActivity = userSalesRecords.length > 0 
            ? new Date(Math.max(...userSalesRecords.map(record => new Date(record.recordedAt))))
            : null;

          // Get assigned stores
          let assignedStores = [];
          if (user.role === 'supervisor') {
            const allocations = supervisorAllocations.filter(alloc => alloc.supervisorId === user.id);
            assignedStores = allocations.map(alloc => this.data.stores.get(alloc.storeId)).filter(Boolean);
          } else if (user.role === 'promodizer') {
            const allocations = promodizerAllocations.filter(alloc => alloc.promodizerId === user.id);
            assignedStores = allocations.map(alloc => this.data.stores.get(alloc.storeId)).filter(Boolean);
          }

          return {
            id: user.id,
            employeeId: user.employeeId,
            firstName: user.firstName,
            lastName: user.lastName,
            name: `${user.firstName} ${user.lastName}`,
            email: user.email,
            phone: user.phone,
            role: user.role,
            assignedStores,
            storesCount: assignedStores.length,
            totalQuantity,
            totalTransactions,
            daysActive,
            avgTransPerDay: parseFloat(avgTransPerDay),
            lastActivity,
            lastActivityDate: lastActivity ? lastActivity.toISOString().split('T')[0] : null
          };
        });

        console.log('Loaded staff performance data:', this.data.allStaff);
      } catch (error) {
        console.error('Error loading staff performance data:', error);
        this.data.allStaff = [];
      }
    },

    populateFilters() {
      const storeFilter = document.getElementById('storeFilter');
      const allStores = Array.from(this.data.stores.values()).sort((a, b) => a.storeName.localeCompare(b.storeName));
      
      storeFilter.innerHTML = allStores.map(store => 
        `<option value="${store.id}">${store.storeName}</option>`
      ).join('');

      // Set default date range (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      document.getElementById('dateStart').value = thirtyDaysAgo.toISOString().split('T')[0];
      document.getElementById('dateEnd').value = today.toISOString().split('T')[0];
    },

    setupEventListeners() {
      // Search
      const searchInput = document.getElementById('searchInput');
      let searchTimeout;
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          this.data.filters.search = e.target.value.toLowerCase();
          this.applyFilters();
        }, 300);
      });

      // Filter controls
      document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
      document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
      document.getElementById('clearFiltersFromEmpty').addEventListener('click', () => this.clearFilters());

      // Role checkboxes
      document.getElementById('rolePromodizer').addEventListener('change', () => this.updateRoleFilters());
      document.getElementById('roleSupervisor').addEventListener('change', () => this.updateRoleFilters());

      // Activity range slider
      const activityMin = document.getElementById('activityMin');
      const activityMinValue = document.getElementById('activityMinValue');
      activityMin.addEventListener('input', (e) => {
        activityMinValue.textContent = e.target.value;
        this.data.filters.activityMin = parseInt(e.target.value);
      });

      // Sort buttons
      document.querySelectorAll('[data-sort]').forEach(button => {
        button.addEventListener('click', (e) => {
          const column = e.currentTarget.dataset.sort;
          this.handleSort(column);
        });
      });

      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => this.changePage(-1));
      document.getElementById('nextPage').addEventListener('click', () => this.changePage(1));

      // Export
      document.getElementById('exportButton').addEventListener('click', () => this.showExportModal());
      document.getElementById('cancelExport').addEventListener('click', () => this.hideExportModal());
      document.getElementById('confirmExport').addEventListener('click', () => this.performExport());

      // Export format change
      document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
        radio.addEventListener('change', () => this.updateExportPreview());
      });
    },

    updateRoleFilters() {
      const roles = [];
      if (document.getElementById('rolePromodizer').checked) roles.push('promodizer');
      if (document.getElementById('roleSupervisor').checked) roles.push('supervisor');
      this.data.filters.roles = roles;
    },

    applyFilters() {
      this.showLoading(true);

      // Update filters from form
      this.updateRoleFilters();
      this.data.filters.dateStart = document.getElementById('dateStart').value;
      this.data.filters.dateEnd = document.getElementById('dateEnd').value;
      
      const storeFilter = document.getElementById('storeFilter');
      this.data.filters.stores = Array.from(storeFilter.selectedOptions).map(option => option.value);

      // Apply filters
      this.data.filteredStaff = this.data.allStaff.filter(staff => {
        // Role filter
        if (!this.data.filters.roles.includes(staff.role)) return false;

        // Search filter
        if (this.data.filters.search) {
          const searchTerm = this.data.filters.search.toLowerCase();
          const searchableText = [
            staff.employeeId,
            staff.firstName,
            staff.lastName,
            staff.email
          ].join(' ').toLowerCase();
          
          if (!searchableText.includes(searchTerm)) return false;
        }

        // Date range filter
        if (this.data.filters.dateStart && staff.lastActivityDate) {
          if (staff.lastActivityDate < this.data.filters.dateStart) return false;
        }
        if (this.data.filters.dateEnd && staff.lastActivityDate) {
          if (staff.lastActivityDate > this.data.filters.dateEnd) return false;
        }

        // Activity level filter
        if (staff.avgTransPerDay < this.data.filters.activityMin) return false;

        // Store filter
        if (this.data.filters.stores.length > 0) {
          const hasAssignedStore = staff.assignedStores.some(store => 
            this.data.filters.stores.includes(store.id)
          );
          if (!hasAssignedStore) return false;
        }

        return true;
      });

      this.sortData();
      this.data.currentPage = 1;
      this.renderActiveFilters();
      this.renderTable();
      this.renderPagination();
      
      setTimeout(() => this.showLoading(false), 300);
    },

    clearFilters() {
      // Reset form controls
      document.getElementById('searchInput').value = '';
      document.getElementById('rolePromodizer').checked = true;
      document.getElementById('roleSupervisor').checked = true;
      document.getElementById('dateStart').value = '';
      document.getElementById('dateEnd').value = '';
      document.getElementById('activityMin').value = '0';
      document.getElementById('activityMinValue').textContent = '0';
      document.getElementById('storeFilter').selectedIndex = -1;

      // Reset filters
      this.data.filters = {
        search: '',
        roles: ['promodizer', 'supervisor'],
        dateStart: '',
        dateEnd: '',
        activityMin: 0,
        stores: []
      };

      this.applyFilters();
    },

    handleSort(column) {
      if (this.data.sortColumn === column) {
        this.data.sortDirection = this.data.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        this.data.sortColumn = column;
        this.data.sortDirection = 'desc';
      }

      this.sortData();
      this.renderTable();
      this.renderPagination();
    },

    sortData() {
      this.data.filteredStaff.sort((a, b) => {
        let aVal = a[this.data.sortColumn];
        let bVal = b[this.data.sortColumn];

        // Handle special cases
        if (this.data.sortColumn === 'name') {
          aVal = `${a.firstName} ${a.lastName}`;
          bVal = `${b.firstName} ${b.lastName}`;
        } else if (this.data.sortColumn === 'lastActivity') {
          aVal = a.lastActivity ? a.lastActivity.getTime() : 0;
          bVal = b.lastActivity ? b.lastActivity.getTime() : 0;
        }

        if (aVal === null || aVal === undefined) aVal = 0;
        if (bVal === null || bVal === undefined) bVal = 0;

        if (typeof aVal === 'string') {
          return this.data.sortDirection === 'asc' 
            ? aVal.localeCompare(bVal)
            : bVal.localeCompare(aVal);
        }

        return this.data.sortDirection === 'asc' ? aVal - bVal : bVal - aVal;
      });
    },

    renderTable() {
      const tbody = document.getElementById('staffTableBody');
      const emptyState = document.getElementById('emptyState');
      const staffCount = document.getElementById('staffCount');

      if (this.data.filteredStaff.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('hidden');
        staffCount.textContent = '0 staff members';
        return;
      }

      emptyState.classList.add('hidden');
      staffCount.textContent = `${this.data.filteredStaff.length} staff member${this.data.filteredStaff.length !== 1 ? 's' : ''}`;

      const start = (this.data.currentPage - 1) * this.data.itemsPerPage;
      const end = start + this.data.itemsPerPage;
      const pageData = this.data.filteredStaff.slice(start, end);

      tbody.innerHTML = pageData.map(staff => {
        const roleClass = staff.role === 'supervisor' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800';
        const lastActivityText = staff.lastActivity 
          ? staff.lastActivity.toLocaleDateString('en-GB')
          : 'No activity';

        const storeNames = staff.assignedStores.map(store => store.storeName).join(', ');
        const storeText = staff.storesCount === 0 
          ? 'No stores assigned'
          : staff.storesCount === 1 
            ? storeNames
            : `${staff.storesCount} stores`;

        return `
          <tr class="hover:bg-slate-50 cursor-pointer" onclick="funNavigateToStaffDetail('${staff.id}')">
            <td class="px-6 py-4 text-sm font-medium text-slate-900">${staff.employeeId || 'N/A'}</td>
            <td class="px-6 py-4">
              <div class="text-sm font-medium text-slate-900">${staff.name}</div>
              <div class="text-xs text-slate-600">${staff.email}</div>
            </td>
            <td class="px-6 py-4">
              <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${roleClass}">
                ${staff.role.charAt(0).toUpperCase() + staff.role.slice(1)}
              </span>
            </td>
            <td class="px-6 py-4 text-sm text-slate-900" title="${storeNames}">
              ${storeText}
            </td>
            <td class="px-6 py-4 text-sm text-slate-900">${staff.totalQuantity.toLocaleString()}</td>
            <td class="px-6 py-4 text-sm text-slate-900">${staff.totalTransactions}</td>
            <td class="px-6 py-4 text-sm text-slate-900">${staff.daysActive}</td>
            <td class="px-6 py-4 text-sm text-slate-900">${staff.avgTransPerDay}</td>
            <td class="px-6 py-4 text-sm text-slate-600">${lastActivityText}</td>
          </tr>
        `;
      }).join('');
    },

    renderActiveFilters() {
      const container = document.getElementById('activeFilters');
      const filters = [];

      // Search filter
      if (this.data.filters.search) {
        filters.push({
          label: `Search: "${this.data.filters.search}"`,
          remove: () => {
            document.getElementById('searchInput').value = '';
            this.data.filters.search = '';
            this.applyFilters();
          }
        });
      }

      // Role filters
      if (this.data.filters.roles.length < 2) {
        filters.push({
          label: `Role: ${this.data.filters.roles.map(r => r.charAt(0).toUpperCase() + r.slice(1)).join(', ')}`,
          remove: () => {
            document.getElementById('rolePromodizer').checked = true;
            document.getElementById('roleSupervisor').checked = true;
            this.data.filters.roles = ['promodizer', 'supervisor'];
            this.applyFilters();
          }
        });
      }

      // Date range filter
      if (this.data.filters.dateStart || this.data.filters.dateEnd) {
        const start = this.data.filters.dateStart ? new Date(this.data.filters.dateStart).toLocaleDateString('en-GB') : 'Start';
        const end = this.data.filters.dateEnd ? new Date(this.data.filters.dateEnd).toLocaleDateString('en-GB') : 'End';
        filters.push({
          label: `Date: ${start} to ${end}`,
          remove: () => {
            document.getElementById('dateStart').value = '';
            document.getElementById('dateEnd').value = '';
            this.data.filters.dateStart = '';
            this.data.filters.dateEnd = '';
            this.applyFilters();
          }
        });
      }

      // Activity filter
      if (this.data.filters.activityMin > 0) {
        filters.push({
          label: `Min Activity: ${this.data.filters.activityMin} trans/day`,
          remove: () => {
            document.getElementById('activityMin').value = '0';
            document.getElementById('activityMinValue').textContent = '0';
            this.data.filters.activityMin = 0;
            this.applyFilters();
          }
        });
      }

      // Store filters
      if (this.data.filters.stores.length > 0) {
        const storeNames = this.data.filters.stores.map(storeId => {
          const store = this.data.stores.get(storeId);
          return store ? store.storeName : storeId;
        });
        
        filters.push({
          label: `Stores: ${storeNames.join(', ')}`,
          remove: () => {
            document.getElementById('storeFilter').selectedIndex = -1;
            this.data.filters.stores = [];
            this.applyFilters();
          }
        });
      }

      container.innerHTML = filters.map(filter => `
        <span class="inline-flex items-center gap-1 px-3 py-1 bg-teal-100 text-teal-800 text-xs rounded-full">
          ${filter.label}
          <button onclick="event.stopPropagation(); (${filter.remove})()" class="ml-1 hover:text-teal-900">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        </span>
      `).join('');

      // Re-initialize lucide icons for the filter tags
      if (window.lucide?.createIcons) {
        window.lucide.createIcons();
      }
    },

    renderPagination() {
      const totalPages = Math.ceil(this.data.filteredStaff.length / this.data.itemsPerPage);
      const prevBtn = document.getElementById('prevPage');
      const nextBtn = document.getElementById('nextPage');
      const paginationInfo = document.getElementById('paginationInfo');
      const pageNumbers = document.getElementById('pageNumbers');

      prevBtn.disabled = this.data.currentPage === 1;
      nextBtn.disabled = this.data.currentPage === totalPages || totalPages === 0;

      const start = (this.data.currentPage - 1) * this.data.itemsPerPage + 1;
      const end = Math.min(this.data.currentPage * this.data.itemsPerPage, this.data.filteredStaff.length);
      
      paginationInfo.textContent = `${start}-${end} of ${this.data.filteredStaff.length}`;

      // Render page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, this.data.currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }

      const pageNumbersHtml = [];
      for (let i = startPage; i <= endPage; i++) {
        const isActive = i === this.data.currentPage;
        pageNumbersHtml.push(`
          <button
            onclick="StaffPerformance.goToPage(${i})"
            class="px-3 py-2 text-sm font-medium rounded ${
              isActive 
                ? 'bg-teal-700 text-white' 
                : 'text-slate-700 bg-white border border-slate-200 hover:bg-slate-50'
            }"
          >
            ${i}
          </button>
        `);
      }

      pageNumbers.innerHTML = pageNumbersHtml.join('');
    },

    changePage(delta) {
      const newPage = this.data.currentPage + delta;
      const totalPages = Math.ceil(this.data.filteredStaff.length / this.data.itemsPerPage);
      
      if (newPage >= 1 && newPage <= totalPages) {
        this.goToPage(newPage);
      }
    },

    goToPage(page) {
      this.data.currentPage = page;
      this.renderTable();
      this.renderPagination();
      
      // Scroll to top of table
      document.getElementById('staffTableContainer').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
    },

    showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const table = document.getElementById('staffTableContainer');
      
      if (show) {
        spinner.classList.remove('hidden');
        table.classList.add('hidden');
      } else {
        spinner.classList.add('hidden');
        table.classList.remove('hidden');
      }
    },

    showExportModal() {
      const modal = document.getElementById('exportModal');
      modal.classList.remove('hidden');
      this.updateExportPreview();
    },

    hideExportModal() {
      const modal = document.getElementById('exportModal');
      const errorDiv = document.getElementById('exportError');
      modal.classList.add('hidden');
      errorDiv.classList.add('hidden');
    },

    updateExportPreview() {
      const formatRadios = document.querySelectorAll('input[name="exportFormat"]');
      const selectedFormat = Array.from(formatRadios).find(r => r.checked)?.value || 'csv';
      const exportFiltered = document.getElementById('exportFiltered').checked;
      
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('exportFileName').textContent = `staff_performance_${today}`;
      document.getElementById('exportFileExt').textContent = `.${selectedFormat}`;
      
      const count = exportFiltered ? this.data.filteredStaff.length : this.data.allStaff.length;
      document.getElementById('exportCount').textContent = `${count} staff member${count !== 1 ? 's' : ''} will be exported`;
    },

    performExport() {
      const formatRadios = document.querySelectorAll('input[name="exportFormat"]');
      const selectedFormat = Array.from(formatRadios).find(r => r.checked)?.value || 'csv';
      const exportFiltered = document.getElementById('exportFiltered').checked;
      const errorDiv = document.getElementById('exportError');

      try {
        const dataToExport = exportFiltered ? this.data.filteredStaff : this.data.allStaff;
        const today = new Date().toISOString().split('T')[0];
        const filename = `staff_performance_${today}.${selectedFormat}`;

        let content, mimeType;

        if (selectedFormat === 'csv') {
          const headers = [
            'Employee ID', 'First Name', 'Last Name', 'Email', 'Phone', 'Role',
            'Assigned Stores Count', 'Total Quantity', 'Total Transactions', 
            'Days Active', 'Avg Transactions per Day', 'Last Activity'
          ];
          
          const rows = dataToExport.map(staff => [
            staff.employeeId || '',
            staff.firstName,
            staff.lastName,
            staff.email,
            staff.phone || '',
            staff.role,
            staff.storesCount,
            staff.totalQuantity,
            staff.totalTransactions,
            staff.daysActive,
            staff.avgTransPerDay,
            staff.lastActivityDate || ''
          ]);

          content = [headers, ...rows]
            .map(row => row.map(cell => `"${cell}"`).join(','))
            .join('\n');
          
          mimeType = 'text/csv';
        } else {
          content = JSON.stringify(dataToExport, null, 2);
          mimeType = 'application/json';
        }

        // Create and trigger download
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        this.hideExportModal();
      } catch (error) {
        console.error('Export failed:', error);
        errorDiv.classList.remove('hidden');
      }
    }
  };

  // Navigation function
  window.funNavigateToStaffDetail = function(staffId) {
    window.location.href = `staff_detail.html?id=${staffId}`;
  };

  // Make StaffPerformance available globally for pagination
  window.StaffPerformance = StaffPerformance;

  // Initialize the application
  StaffPerformance.init();
});
</script></body></html>