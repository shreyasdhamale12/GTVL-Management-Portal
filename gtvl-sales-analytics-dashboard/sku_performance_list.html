<html lang="en"><head>
    <meta charset="UTF-8">
    <title>Sales Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style type="text/tailwindcss">
      @theme {
        --color-primary: #0F766E;
        --color-primary-hover: #0D9488;
        --color-secondary: #475569;
        --color-accent: #D97706;
        --color-background: #F8FAFC;
        --color-surface: #FFFFFF;
        --color-surface-variant: #F1F5F9;
        --color-on-background: #0F172A;
        --color-on-surface: #1E293B;
        --color-border: #E2E8F0;
        --color-success: #16A34A;
        --color-warning: #F59E0B;
        --color-error: #DC2626;
        --color-info: #2563EB;
        --header-height: 4rem;
        --sidebar-width: 16rem;
      }

      html {
        scroll-behavior: smooth;
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .app-header {
        height: var(--header-height);
      }
      .app-sidebar {
        top: var(--header-height);
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
      }
      .app-main {
        margin-top: var(--header-height);
        min-height: calc(100vh - var(--header-height));
      }
      @media (min-width: 768px) {
        .app-main {
          margin-left: var(--sidebar-width);
        }
      }

      @media (max-width: 767px) {
        .app-sidebar {
          left: calc(-1 * var(--sidebar-width));
          transition: left 0.3s ease-in-out;
        }
        .app-sidebar.open {
          left: 0;
        }
      }

      .nav-link.active {
        border-left: 3px solid var(--color-primary);
        padding-left: calc(1rem - 3px);
      }

      .popover {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out,
          visibility 0.2s ease-in-out;
      }
      .popover.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .sidebar-backdrop {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .sidebar-backdrop.active {
        opacity: 1;
        visibility: visible;
      }
    </style>
  <title>SKU Performance Analysis</title></head>
  <body class="bg-slate-50 text-slate-800 overflow-x-hidden">
    <header class="app-header fixed top-0 left-0 right-0 bg-white border-b border-slate-200 z-40">
      <div class="h-full max-w-[1920px] mx-auto px-4 md:px-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <button id="mobileMenuToggle" class="flex items-center justify-center w-10 h-10 rounded text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition-all duration-200 cursor-pointer border-0 bg-transparent md:hidden focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="Toggle navigation menu" aria-expanded="false">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>

          <div class="flex items-center gap-3">
            <div class="w-8 h-8 flex items-center justify-center">
              <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="68" y="68" width="264" height="264" rx="32" stroke="#0F766E" stroke-width="18"></rect>
                <rect x="109" y="143" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="143" width="71" height="33" rx="8" fill="#D97706"></rect>
                <rect x="206" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
              </svg>
            </div>
            <h1 class="text-lg md:text-xl font-bold text-slate-900">Sales Analytics Dashboard</h1>
          </div>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
          <button id="userProfileButton" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-transparent hover:bg-slate-50 hover:border-slate-200 transition-all duration-200 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="User profile menu" aria-expanded="false" aria-haspopup="true">
            <div id="userAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
            <div class="hidden sm:flex flex-col items-start">
              <div id="userName" class="text-sm font-medium text-slate-900"></div>
            </div>
            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 hidden sm:block"></i>
          </button>
        </div>
      </div>
    </header>

    <div id="userProfilePopover" class="popover absolute top-[4.5rem] right-4 md:right-6 w-72 bg-white border border-slate-200 rounded-lg shadow-xl z-50" role="dialog" aria-labelledby="popoverUserName" data-portal="body">
      <div class="p-4">
        <div class="flex items-center gap-3 pb-3 mb-3 border-b border-slate-100">
          <div id="popoverUserAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div id="popoverUserName" class="font-semibold text-slate-900 truncate"></div>
            <div id="popoverUserEmail" class="text-xs text-slate-600 truncate"></div>
          </div>
        </div>

        <div class="space-y-1">
          <button id="signOutButton" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-md transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            Sign Out
          </button>
        </div>
      </div>
    </div>

    <div id="sidebarBackdrop" class="sidebar-backdrop fixed inset-0 bg-black/50 z-20 md:hidden" style="top: var(--header-height)"></div>

    <aside id="sidebar" class="app-sidebar fixed left-0 bg-white border-r border-slate-200 overflow-y-auto z-30 transition-transform duration-300 ease-in-out">
      <nav class="p-4" role="navigation" aria-label="Main navigation">
        <div class="py-6 border-b border-slate-100 first:pt-0 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Analytics</div>
          <div class="space-y-1">
            <a href="dashboard.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline active bg-teal-50 text-teal-700" data-page="dashboard">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a href="sku_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="sku_performance">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>SKU Performance</span>
            </a>
            <a href="store_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="store_performance">
              <i data-lucide="store" class="w-5 h-5"></i>
              <span>Store Performance</span>
            </a>
            <a href="staff_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="staff_performance">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Staff Performance</span>
            </a>
            <a href="transaction_history.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="transaction_history">
              <i data-lucide="receipt" class="w-5 h-5"></i>
              <span>Transaction History</span>
            </a>
          </div>
        </div>

        <div class="py-6 border-b border-slate-100 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Tools</div>
          <div class="space-y-1">
            <a href="reports_configuration.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="reports">
              <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
              <span>Reports</span>
            </a>
            <a href="settings.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
              <span>Settings</span>
            </a>
          </div>
        </div>
      </nav>
    </aside>

    <main class="app-main p-6" id="pageContent" role="main"><div class="mb-6">
  <nav class="flex" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm">
      <li>
        <a href="dashboard.html" class="text-teal-700 hover:text-teal-600 font-medium no-underline">Dashboard</a>
      </li>
      <li>
        <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
      </li>
      <li>
        <span class="text-slate-600 font-medium">SKU Performance</span>
      </li>
    </ol>
  </nav>
</div>

<!-- Page Header -->
<div class="bg-white rounded-lg shadow-sm border border-slate-200 p-6 mb-6">
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
    <div>
      <h1 class="text-[1.75rem] leading-[2.25rem] font-bold text-slate-900">SKU Performance Analysis</h1>
      <p class="text-sm text-slate-600 mt-1">Analyze product performance across all stores and time periods</p>
    </div>
    <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
      <div class="flex items-center gap-2">
        <label for="dateRange" class="text-sm font-medium text-slate-700">Date Range:</label>
        <select id="dateRange" class="px-3 py-2 border border-slate-200 rounded text-sm bg-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
          <option value="all">All Time</option>
          <option value="7">Last 7 Days</option>
          <option value="30" selected="">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <button id="exportBtn" class="flex items-center gap-2 px-4 py-2 bg-teal-700 text-white rounded font-medium hover:bg-teal-600 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
        <i data-lucide="download" class="w-4 h-4"></i>
        Export
      </button>
    </div>
  </div>
  
  <!-- Search Bar -->
  <div class="mt-4">
    <div class="relative">
      <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-slate-400"></i>
      <input type="text" id="searchInput" placeholder="Search by SKU code, product name, or barcode..." class="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-teal-500">
    </div>
  </div>
</div>

<!-- Filters and Content -->
<div class="flex gap-6">
  <!-- Sidebar Filters -->
  <div class="hidden lg:block w-64 bg-white rounded-lg shadow-sm border border-slate-200 p-6 h-fit">
    <h3 class="text-base leading-6 font-semibold text-slate-900 mb-4">Filters</h3>
    
    <!-- Category Filter -->
    <div class="mb-6">
      <label class="text-sm font-medium text-slate-700 mb-2 block">Category</label>
      <div class="space-y-2" id="categoryFilters">
        <!-- Categories will be populated dynamically -->
      </div>
    </div>

    <!-- Status Filter -->
    <div class="mb-6">
      <label class="text-sm font-medium text-slate-700 mb-2 block">Status</label>
      <div class="space-y-2">
        <label class="flex items-center">
          <input type="checkbox" id="statusActive" checked="" class="rounded border-slate-300 text-teal-700 focus:ring-teal-500 focus:ring-offset-0">
          <span class="ml-2 text-sm text-slate-600">Active</span>
        </label>
        <label class="flex items-center">
          <input type="checkbox" id="statusInactive" class="rounded border-slate-300 text-teal-700 focus:ring-teal-500 focus:ring-offset-0">
          <span class="ml-2 text-sm text-slate-600">Inactive</span>
        </label>
      </div>
    </div>

    <!-- Quantity Range -->
    <div class="mb-6">
      <label class="text-sm font-medium text-slate-700 mb-2 block">Total Quantity Sold</label>
      <div class="flex items-center gap-2">
        <input type="number" id="minQuantity" placeholder="Min" class="flex-1 px-2 py-1 border border-slate-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-teal-500">
        <span class="text-slate-400">-</span>
        <input type="number" id="maxQuantity" placeholder="Max" class="flex-1 px-2 py-1 border border-slate-200 rounded text-sm focus:outline-none focus:ring-1 focus:ring-teal-500">
      </div>
    </div>

    <!-- Filter Actions -->
    <div class="space-y-2">
      <button id="applyFilters" class="w-full px-4 py-2 bg-teal-700 text-white rounded font-medium hover:bg-teal-600 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
        Apply Filters
      </button>
      <button id="clearFilters" class="w-full px-4 py-2 border border-slate-200 text-slate-600 rounded font-medium hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
        Clear All
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div class="flex-1">
    <!-- Active Filters -->
    <div id="activeFilters" class="mb-4 hidden">
      <div class="flex flex-wrap gap-2">
        <!-- Active filter tags will be inserted here -->
      </div>
    </div>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="hidden bg-white rounded-lg shadow-sm border border-slate-200 p-8">
      <div class="flex items-center justify-center">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-700"></div>
        <span class="ml-3 text-slate-600">Loading SKU performance data...</span>
      </div>
    </div>

    <!-- SKU Performance Table -->
    <div id="skuTableContainer" class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="w-full">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="skuCode">
                <div class="flex items-center gap-1">
                  SKU Code
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="productName">
                <div class="flex items-center gap-1">
                  Product Name
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="category">
                <div class="flex items-center gap-1">
                  Category
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="totalQuantity">
                <div class="flex items-center justify-end gap-1">
                  Total Sold
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="totalTransactions">
                <div class="flex items-center justify-end gap-1">
                  Transactions
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="storesCount">
                <div class="flex items-center justify-end gap-1">
                  Stores
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="avgQuantity">
                <div class="flex items-center justify-end gap-1">
                  Avg/Transaction
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 cursor-pointer hover:bg-slate-100" data-sort="lastSaleDate">
                <div class="flex items-center justify-end gap-1">
                  Last Sale
                  <i data-lucide="chevron-up-down" class="w-4 h-4 opacity-50"></i>
                </div>
              </th>
            </tr>
          </thead>
          <tbody id="skuTableBody" class="divide-y divide-slate-200">
            <!-- Rows will be populated dynamically -->
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="bg-slate-50 px-4 py-3 border-t border-slate-200">
        <div class="flex items-center justify-between">
          <div class="text-sm text-slate-600">
            Showing <span id="paginationInfo">0 - 0 of 0</span> SKUs
          </div>
          <div class="flex items-center gap-2">
            <button id="prevPage" class="px-3 py-1 border border-slate-200 rounded text-sm hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2" disabled="">
              Previous
            </button>
            <div id="pageNumbers" class="flex items-center gap-1">
              <!-- Page numbers will be populated dynamically -->
            </div>
            <button id="nextPage" class="px-3 py-1 border border-slate-200 rounded text-sm hover:bg-white disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2" disabled="">
              Next
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden bg-white rounded-lg shadow-sm border border-slate-200 p-12 text-center">
      <i data-lucide="package-x" class="w-12 h-12 text-slate-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-slate-900 mb-2">No SKUs Found</h3>
      <p class="text-slate-600 mb-6">No SKUs match your current filters. Try adjusting your search criteria.</p>
      <button id="resetFiltersBtn" class="px-4 py-2 bg-teal-700 text-white rounded font-medium hover:bg-teal-600 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
        Reset Filters
      </button>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div id="exportModal" data-portal="body" class="fixed inset-0 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4 bg-black/50">
    <div class="bg-white rounded-xl shadow-xl w-[min(92vw,28rem)] max-h-[90vh] overflow-y-auto">
      <div class="p-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-semibold text-slate-900">Export SKU Performance Data</h3>
          <button id="closeExportModal" class="p-1 text-slate-400 hover:text-slate-600 rounded focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
            <i data-lucide="x" class="w-5 h-5"></i>
          </button>
        </div>

        <div class="space-y-4">
          <!-- Export Format -->
          <div>
            <label class="text-sm font-medium text-slate-700 mb-2 block">Export Format</label>
            <div class="space-y-2">
              <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                <input type="radio" name="exportFormat" value="csv" checked="" class="text-teal-700 focus:ring-teal-500">
                <div class="ml-3">
                  <div class="text-sm font-medium text-slate-900">CSV Format</div>
                  <div class="text-xs text-slate-600">Comma-separated values for Excel</div>
                </div>
              </label>
              <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                <input type="radio" name="exportFormat" value="json" class="text-teal-700 focus:ring-teal-500">
                <div class="ml-3">
                  <div class="text-sm font-medium text-slate-900">JSON Format</div>
                  <div class="text-xs text-slate-600">JavaScript Object Notation</div>
                </div>
              </label>
            </div>
          </div>

          <!-- File Name Preview -->
          <div>
            <label class="text-sm font-medium text-slate-700 mb-2 block">File Name</label>
            <div class="p-2 bg-slate-50 border border-slate-200 rounded text-sm text-slate-700" id="fileNamePreview">
              sku_performance_2024-11-24.csv
            </div>
          </div>

          <!-- Export Options -->
          <div>
            <label class="flex items-center">
              <input type="checkbox" id="includeFiltered" checked="" class="rounded border-slate-300 text-teal-700 focus:ring-teal-500 focus:ring-offset-0">
              <span class="ml-2 text-sm text-slate-700">Include only filtered results</span>
            </label>
          </div>

          <!-- Export Summary -->
          <div class="p-3 bg-blue-50 border border-blue-200 rounded">
            <div class="text-sm text-blue-800">
              <div id="exportSummary">Ready to export all SKU performance data</div>
            </div>
          </div>

          <!-- Error Message -->
          <div id="exportError" class="hidden p-3 bg-red-50 border border-red-200 rounded">
            <div class="flex items-center gap-2 text-sm text-red-800">
              <i data-lucide="alert-circle" class="w-4 h-4"></i>
              <span>Export failed. Please try again.</span>
            </div>
          </div>
        </div>

        <div class="flex justify-end gap-3 mt-6">
          <button id="cancelExport" class="px-4 py-2 border border-slate-200 text-slate-600 rounded font-medium hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
            Cancel
          </button>
          <button id="confirmExport" class="px-4 py-2 bg-teal-700 text-white rounded font-medium hover:bg-teal-600 transition-colors focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2">
            Export
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

</main>

    <script src="app.js"></script>
    <script src="app_data.js"></script>
    <script id="container-script">
      (function () {
        const TemplateUtils = (window.TemplateUtils = window.TemplateUtils || {});

        TemplateUtils.UserUtils =
          TemplateUtils.UserUtils ||
          (function createUserUtils() {
            return {
              getCurrentUser() {
                try {
                  let currentUserId = localStorage.getItem("currentUserId");
                  if (!currentUserId) {
                    localStorage.setItem("currentUserId", "usr_sales_001");
                    currentUserId = "usr_sales_001";
                  }

                  const users = JSON.parse(localStorage.getItem("users") || "[]");
                  return users.find(user => user.id === currentUserId) || null;
                } catch (error) {
                  console.error("Error retrieving user data:", error);
                  return null;
                }
              },
              signOut() {
                try {
                  localStorage.removeItem("currentUserId");
                  window.location.reload();
                } catch (error) {
                  console.error("Error signing out:", error);
                }
              },
              getUserDisplayName(user) {
                if (!user) return "Guest";
                return user.firstName && user.lastName
                  ? `${user.firstName} ${user.lastName}`
                  : user.firstName || user.lastName || "User";
              },
              getUserInitials(user) {
                if (!user) return "?";
                const first = user.firstName?.charAt(0) || "";
                const last = user.lastName?.charAt(0) || "";
                return (first + last).toUpperCase() || "U";
              },
            };
          })();

        if (TemplateUtils.__bootstrapped) {
          if (typeof window.lucide?.createIcons === "function") {
            window.lucide.createIcons();
          }
          return;
        }

        TemplateUtils.__bootstrapped = true;

        const state = {
          popoverVisible: false,
          sidebarOpen: false,
          resizeTimer: null,
          observerFrame: null,
          refs: {},
        };

        function ready(fn) {
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", fn, { once: true });
          } else if (typeof queueMicrotask === "function") {
            queueMicrotask(fn);
          } else {
            Promise.resolve().then(fn);
          }
        }

        function safeLucide(callback) {
          if (typeof window.lucide?.createIcons === "function") {
            callback();
          }
        }

        function cacheRefs() {
          state.refs = {
            userProfileButton: document.getElementById("userProfileButton"),
            userProfilePopover: document.getElementById("userProfilePopover"),
            userAvatar: document.getElementById("userAvatar"),
            userName: document.getElementById("userName"),
            popoverUserAvatar: document.getElementById("popoverUserAvatar"),
            popoverUserName: document.getElementById("popoverUserName"),
            popoverUserEmail: document.getElementById("popoverUserEmail"),
            signOutButton: document.getElementById("signOutButton"),
            mobileMenuToggle: document.getElementById("mobileMenuToggle"),
            sidebar: document.getElementById("sidebar"),
            sidebarBackdrop: document.getElementById("sidebarBackdrop"),
            navLinks: document.querySelectorAll(".nav-link"),
            pageContent: document.getElementById("pageContent"),
          };
        }

        function initializeUserProfile() {
          const { userAvatar, userName } = state.refs;
          if (!userAvatar || !userName) return;

          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          if (currentUser) {
            userAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            userName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
          } else {
            userAvatar.textContent = "?";
            userName.textContent = "Guest";
          }
        }

        function populatePopover() {
          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          const { popoverUserAvatar, popoverUserName, popoverUserEmail } = state.refs;
          if (!popoverUserAvatar || !popoverUserName || !popoverUserEmail) return;

          if (currentUser) {
            popoverUserAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            popoverUserName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
            popoverUserEmail.textContent = currentUser.email || "No email";
          } else {
            popoverUserAvatar.textContent = "?";
            popoverUserName.textContent = "Guest";
            popoverUserEmail.textContent = "Not logged in";
          }
        }

        function toggleUserPopover(forceClose = false) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (!userProfilePopover || !userProfileButton) return;

          const shouldOpen = forceClose ? false : !state.popoverVisible;
          if (shouldOpen) {
            populatePopover();
            userProfilePopover.classList.add("visible");
            userProfileButton.setAttribute("aria-expanded", "true");
            state.popoverVisible = true;
            const firstButton = userProfilePopover.querySelector("button");
            if (firstButton) {
              setTimeout(() => firstButton.focus(), 50);
            }
          } else {
            userProfilePopover.classList.remove("visible");
            userProfileButton.setAttribute("aria-expanded", "false");
            state.popoverVisible = false;
          }
        }

        function hideUserPopover() {
          if (state.popoverVisible) {
            toggleUserPopover(true);
          }
        }

        function toggleMobileSidebar(forceClose = false) {
          const { sidebar, sidebarBackdrop, mobileMenuToggle } = state.refs;
          if (!sidebar || !sidebarBackdrop || !mobileMenuToggle) return;

          const shouldOpen = forceClose ? false : !state.sidebarOpen;
          state.sidebarOpen = shouldOpen;

          sidebar.classList.toggle("open", shouldOpen);
          sidebarBackdrop.classList.toggle("active", shouldOpen);
          mobileMenuToggle.setAttribute("aria-expanded", shouldOpen ? "true" : "false");
          document.body.style.overflow = shouldOpen ? "hidden" : "";
        }

        function closeMobileSidebar() {
          if (state.sidebarOpen) {
            toggleMobileSidebar(true);
          }
        }

        function setActiveNavLink(pageId) {
          if (!pageId) return;
          const { navLinks } = state.refs;
          navLinks?.forEach((link) => {
            if (link.dataset.page === pageId) {
              link.classList.add("active", "bg-teal-50", "text-teal-700");
            } else {
              link.classList.remove("active", "bg-teal-50", "text-teal-700");
            }
          });
        }

        TemplateUtils.setActiveNavLink = setActiveNavLink;
        TemplateUtils.closeMobileSidebar = closeMobileSidebar;

        function handleDocumentClick(event) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (
            state.popoverVisible &&
            userProfilePopover &&
            userProfileButton &&
            !userProfilePopover.contains(event.target) &&
            !userProfileButton.contains(event.target)
          ) {
            hideUserPopover();
          }
        }

        function handleKeydown(event) {
          if (event.key !== "Escape") return;
          if (state.popoverVisible) {
            hideUserPopover();
            state.refs.userProfileButton?.focus();
          }
          if (state.sidebarOpen) {
            closeMobileSidebar();
            state.refs.mobileMenuToggle?.focus();
          }
        }

        function handleResize() {
          clearTimeout(state.resizeTimer);
          state.resizeTimer = setTimeout(() => {
            if (window.innerWidth >= 768) {
              closeMobileSidebar();
            }
          }, 200);
        }

        function bindEvents() {
          const {
            userProfileButton,
            mobileMenuToggle,
            sidebarBackdrop,
            signOutButton,
            navLinks,
          } = state.refs;

          userProfileButton?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleUserPopover();
          });

          mobileMenuToggle?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleMobileSidebar();
          });

          sidebarBackdrop?.addEventListener("click", () => closeMobileSidebar());

          signOutButton?.addEventListener("click", () => {
            if (confirm("Are you sure you want to sign out?")) {
              TemplateUtils.UserUtils.signOut();
            }
          });

          navLinks?.forEach((link) => {
            link.addEventListener("click", () => closeMobileSidebar());
          });

          document.addEventListener("click", handleDocumentClick);
          document.addEventListener("keydown", handleKeydown);
          window.addEventListener("resize", handleResize);
        }

        function initializePortalTargets() {
          document.querySelectorAll('[data-portal="body"]').forEach((node) => {
            if (node.parentElement !== document.body) {
              document.body.appendChild(node);
            }
          });
        }

        function observePageContent() {
          const { pageContent } = state.refs;
          if (!pageContent || typeof MutationObserver !== "function") return;

          const observer = new MutationObserver(() => {
            if (state.observerFrame) return;
            state.observerFrame = requestAnimationFrame(() => {
              state.observerFrame = null;
              safeLucide(() => window.lucide.createIcons());
            });
          });

          observer.observe(pageContent, { childList: true, subtree: true });
          state.observer = observer;
        }

        function bootstrap() {
          cacheRefs();
          initializePortalTargets();
          initializeUserProfile();
          bindEvents();
          safeLucide(() => window.lucide.createIcons());
          observePageContent();
        }

        ready(bootstrap);
      })();
    </script>
  

<script>
// Utility: portal a modal by id (idempotent)
function funPortalModalToBody(id){
  const el = document.getElementById(id);
  if (el && el.parentElement !== document.body) document.body.appendChild(el);
}

document.addEventListener('DOMContentLoaded', () => {
  // Set active navigation
  if (window.TemplateUtils?.setActiveNavLink) {
    window.TemplateUtils.setActiveNavLink('sku_performance');
  }

  // Auto-portal any modal declaring data-portal="body"
  document.querySelectorAll('[data-portal="body"]').forEach(el => {
    if (el.parentElement !== document.body) document.body.appendChild(el);
  });

  // SKU Performance Manager
  const SKUPerformanceManager = {
    data: {
      skus: [],
      salesRecords: [],
      processedData: [],
      filteredData: [],
      currentPage: 1,
      itemsPerPage: 50,
      sortColumn: 'totalQuantity',
      sortDirection: 'desc',
      searchQuery: '',
      filters: {
        categories: new Set(),
        statusActive: true,
        statusInactive: false,
        minQuantity: null,
        maxQuantity: null,
        dateRange: '30'
      },
      searchTimeout: null
    },

    init() {
      this.loadData();
      this.bindEvents();
      this.setupCategoryFilters();
      this.processData();
      this.updateFileNamePreview();
    },

    loadData() {
      try {
        this.data.skus = JSON.parse(localStorage.getItem('skus') || '[]');
        this.data.salesRecords = JSON.parse(localStorage.getItem('salesRecords') || '[]');
      } catch (error) {
        console.error('Error loading data:', error);
        this.data.skus = [];
        this.data.salesRecords = [];
      }
    },

    bindEvents() {
      // Search
      document.getElementById('searchInput').addEventListener('input', (e) => {
        clearTimeout(this.data.searchTimeout);
        this.data.searchTimeout = setTimeout(() => {
          this.data.searchQuery = e.target.value.toLowerCase();
          this.applyFilters();
        }, 300);
      });

      // Date range filter
      document.getElementById('dateRange').addEventListener('change', (e) => {
        this.data.filters.dateRange = e.target.value;
        this.applyFilters();
      });

      // Filter buttons
      document.getElementById('applyFilters').addEventListener('click', () => this.applyFilters());
      document.getElementById('clearFilters').addEventListener('click', () => this.clearFilters());
      document.getElementById('resetFiltersBtn').addEventListener('click', () => this.clearFilters());

      // Status filters
      document.getElementById('statusActive').addEventListener('change', (e) => {
        this.data.filters.statusActive = e.target.checked;
      });
      document.getElementById('statusInactive').addEventListener('change', (e) => {
        this.data.filters.statusInactive = e.target.checked;
      });

      // Quantity range
      document.getElementById('minQuantity').addEventListener('change', (e) => {
        this.data.filters.minQuantity = e.target.value ? parseInt(e.target.value) : null;
      });
      document.getElementById('maxQuantity').addEventListener('change', (e) => {
        this.data.filters.maxQuantity = e.target.value ? parseInt(e.target.value) : null;
      });

      // Table sorting
      document.querySelectorAll('[data-sort]').forEach(th => {
        th.addEventListener('click', () => {
          const column = th.dataset.sort;
          if (this.data.sortColumn === column) {
            this.data.sortDirection = this.data.sortDirection === 'asc' ? 'desc' : 'asc';
          } else {
            this.data.sortColumn = column;
            this.data.sortDirection = 'desc';
          }
          this.updateSortIcons();
          this.sortAndRenderTable();
        });
      });

      // Pagination
      document.getElementById('prevPage').addEventListener('click', () => {
        if (this.data.currentPage > 1) {
          this.data.currentPage--;
          this.renderTable();
        }
      });
      document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(this.data.filteredData.length / this.data.itemsPerPage);
        if (this.data.currentPage < totalPages) {
          this.data.currentPage++;
          this.renderTable();
        }
      });

      // Export functionality
      document.getElementById('exportBtn').addEventListener('click', () => {
        this.showExportModal();
      });
      document.getElementById('closeExportModal').addEventListener('click', () => {
        this.hideExportModal();
      });
      document.getElementById('cancelExport').addEventListener('click', () => {
        this.hideExportModal();
      });
      document.getElementById('confirmExport').addEventListener('click', () => {
        this.performExport();
      });

      // Export format change
      document.querySelectorAll('input[name="exportFormat"]').forEach(radio => {
        radio.addEventListener('change', () => {
          this.updateFileNamePreview();
        });
      });
    },

    setupCategoryFilters() {
      const categories = [...new Set(this.data.skus.map(sku => sku.category))].sort();
      const categoryFiltersEl = document.getElementById('categoryFilters');
      categoryFiltersEl.innerHTML = '';

      categories.forEach(category => {
        const label = document.createElement('label');
        label.className = 'flex items-center';
        label.innerHTML = `
          <input type="checkbox" value="${category}" class="rounded border-slate-300 text-teal-700 focus:ring-teal-500 focus:ring-offset-0 category-filter">
          <span class="ml-2 text-sm text-slate-600">${category}</span>
        `;
        categoryFiltersEl.appendChild(label);
      });

      // Bind category filter events
      document.querySelectorAll('.category-filter').forEach(cb => {
        cb.addEventListener('change', (e) => {
          if (e.target.checked) {
            this.data.filters.categories.add(e.target.value);
          } else {
            this.data.filters.categories.delete(e.target.value);
          }
        });
      });
    },

    processData() {
      this.showLoading();

      // Create a map to aggregate sales data by SKU
      const skuSalesMap = new Map();

      // Filter sales records by date range if needed
      const filteredSales = this.filterSalesByDateRange(this.data.salesRecords);

      // Aggregate sales data
      filteredSales.forEach(sale => {
        sale.scannedSkus.forEach(scannedSku => {
          const skuId = scannedSku.skuId;
          
          if (!skuSalesMap.has(skuId)) {
            skuSalesMap.set(skuId, {
              totalQuantity: 0,
              transactionIds: new Set(),
              storeIds: new Set(),
              lastSaleDate: null
            });
          }

          const skuData = skuSalesMap.get(skuId);
          skuData.totalQuantity += scannedSku.quantity;
          skuData.transactionIds.add(sale.id);
          skuData.storeIds.add(sale.storeId);
          
          const saleDate = new Date(sale.recordedAt);
          if (!skuData.lastSaleDate || saleDate > skuData.lastSaleDate) {
            skuData.lastSaleDate = saleDate;
          }
        });
      });

      // Combine SKU master data with sales performance
      this.data.processedData = this.data.skus.map(sku => {
        const salesData = skuSalesMap.get(sku.id) || {
          totalQuantity: 0,
          transactionIds: new Set(),
          storeIds: new Set(),
          lastSaleDate: null
        };

        return {
          ...sku,
          totalQuantity: salesData.totalQuantity,
          totalTransactions: salesData.transactionIds.size,
          storesCount: salesData.storeIds.size,
          avgQuantity: salesData.transactionIds.size > 0 ? 
            (salesData.totalQuantity / salesData.transactionIds.size).toFixed(1) : '0.0',
          lastSaleDate: salesData.lastSaleDate ? salesData.lastSaleDate.toISOString().split('T')[0] : 'Never'
        };
      });

      this.applyFilters();
      this.hideLoading();
    },

    filterSalesByDateRange(salesRecords) {
      const dateRange = this.data.filters.dateRange;
      if (dateRange === 'all') return salesRecords;

      const now = new Date();
      let startDate;

      switch (dateRange) {
        case '7':
          startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          break;
        case '30':
          startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          break;
        case '90':
          startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
          break;
        default:
          return salesRecords;
      }

      return salesRecords.filter(sale => {
        const saleDate = new Date(sale.recordedAt);
        return saleDate >= startDate;
      });
    },

    applyFilters() {
      let filtered = [...this.data.processedData];

      // Search filter
      if (this.data.searchQuery) {
        filtered = filtered.filter(sku => 
          sku.skuCode.toLowerCase().includes(this.data.searchQuery) ||
          sku.productName.toLowerCase().includes(this.data.searchQuery) ||
          sku.barcode.toLowerCase().includes(this.data.searchQuery)
        );
      }

      // Category filter
      if (this.data.filters.categories.size > 0) {
        filtered = filtered.filter(sku => this.data.filters.categories.has(sku.category));
      }

      // Status filter
      if (this.data.filters.statusActive && !this.data.filters.statusInactive) {
        filtered = filtered.filter(sku => sku.status === 'active');
      } else if (!this.data.filters.statusActive && this.data.filters.statusInactive) {
        filtered = filtered.filter(sku => sku.status === 'inactive');
      } else if (!this.data.filters.statusActive && !this.data.filters.statusInactive) {
        filtered = [];
      }

      // Quantity range filter
      if (this.data.filters.minQuantity !== null) {
        filtered = filtered.filter(sku => sku.totalQuantity >= this.data.filters.minQuantity);
      }
      if (this.data.filters.maxQuantity !== null) {
        filtered = filtered.filter(sku => sku.totalQuantity <= this.data.filters.maxQuantity);
      }

      this.data.filteredData = filtered;
      this.data.currentPage = 1;
      this.updateActiveFilters();
      this.sortAndRenderTable();
    },

    clearFilters() {
      // Reset all filters
      this.data.searchQuery = '';
      this.data.filters.categories.clear();
      this.data.filters.statusActive = true;
      this.data.filters.statusInactive = false;
      this.data.filters.minQuantity = null;
      this.data.filters.maxQuantity = null;
      this.data.filters.dateRange = '30';

      // Reset UI elements
      document.getElementById('searchInput').value = '';
      document.getElementById('dateRange').value = '30';
      document.querySelectorAll('.category-filter').forEach(cb => cb.checked = false);
      document.getElementById('statusActive').checked = true;
      document.getElementById('statusInactive').checked = false;
      document.getElementById('minQuantity').value = '';
      document.getElementById('maxQuantity').value = '';

      // Reprocess and apply filters
      this.processData();
    },

    updateActiveFilters() {
      const activeFiltersEl = document.getElementById('activeFilters');
      const hasFilters = this.data.searchQuery || 
                        this.data.filters.categories.size > 0 ||
                        (!this.data.filters.statusActive || this.data.filters.statusInactive) ||
                        this.data.filters.minQuantity !== null ||
                        this.data.filters.maxQuantity !== null ||
                        this.data.filters.dateRange !== 'all';

      if (!hasFilters) {
        activeFiltersEl.classList.add('hidden');
        return;
      }

      activeFiltersEl.classList.remove('hidden');
      activeFiltersEl.innerHTML = '<div class="flex flex-wrap gap-2"></div>';
      const container = activeFiltersEl.querySelector('div');

      // Search filter tag
      if (this.data.searchQuery) {
        this.addFilterTag(container, 'Search', this.data.searchQuery, () => {
          this.data.searchQuery = '';
          document.getElementById('searchInput').value = '';
          this.applyFilters();
        });
      }

      // Category filter tags
      this.data.filters.categories.forEach(category => {
        this.addFilterTag(container, 'Category', category, () => {
          this.data.filters.categories.delete(category);
          document.querySelector(`input[value="${category}"]`).checked = false;
          this.applyFilters();
        });
      });

      // Status filter tags
      if (!this.data.filters.statusActive || this.data.filters.statusInactive) {
        const status = this.data.filters.statusInactive ? 'Inactive Only' : 'None Selected';
        this.addFilterTag(container, 'Status', status, () => {
          this.data.filters.statusActive = true;
          this.data.filters.statusInactive = false;
          document.getElementById('statusActive').checked = true;
          document.getElementById('statusInactive').checked = false;
          this.applyFilters();
        });
      }

      // Quantity range filter
      if (this.data.filters.minQuantity !== null || this.data.filters.maxQuantity !== null) {
        const min = this.data.filters.minQuantity || 0;
        const max = this.data.filters.maxQuantity || 'âˆž';
        this.addFilterTag(container, 'Quantity', `${min} - ${max}`, () => {
          this.data.filters.minQuantity = null;
          this.data.filters.maxQuantity = null;
          document.getElementById('minQuantity').value = '';
          document.getElementById('maxQuantity').value = '';
          this.applyFilters();
        });
      }
    },

    addFilterTag(container, label, value, onRemove) {
      const tag = document.createElement('span');
      tag.className = 'inline-flex items-center gap-1 px-3 py-1 bg-teal-100 text-teal-800 rounded-full text-sm';
      tag.innerHTML = `
        <span>${label}: ${value}</span>
        <button class="hover:bg-teal-200 rounded-full p-0.5 focus:outline-none focus:ring-1 focus:ring-teal-500">
          <i data-lucide="x" class="w-3 h-3"></i>
        </button>
      `;
      
      tag.querySelector('button').addEventListener('click', onRemove);
      container.appendChild(tag);

      // Re-create Lucide icons for the new tag
      if (window.lucide?.createIcons) {
        window.lucide.createIcons();
      }
    },

    sortAndRenderTable() {
      // Sort data
      this.data.filteredData.sort((a, b) => {
        let aVal = a[this.data.sortColumn];
        let bVal = b[this.data.sortColumn];

        // Handle numeric columns
        if (['totalQuantity', 'totalTransactions', 'storesCount', 'avgQuantity'].includes(this.data.sortColumn)) {
          aVal = parseFloat(aVal) || 0;
          bVal = parseFloat(bVal) || 0;
        }
        // Handle date columns
        else if (this.data.sortColumn === 'lastSaleDate') {
          if (aVal === 'Never') aVal = new Date('1900-01-01');
          else aVal = new Date(aVal);
          if (bVal === 'Never') bVal = new Date('1900-01-01');
          else bVal = new Date(bVal);
        }
        // Handle string columns
        else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (aVal < bVal) return this.data.sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return this.data.sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      this.renderTable();
    },

    updateSortIcons() {
      document.querySelectorAll('[data-sort] i').forEach(icon => {
        icon.setAttribute('data-lucide', 'chevron-up-down');
        icon.className = 'w-4 h-4 opacity-50';
      });

      const activeHeader = document.querySelector(`[data-sort="${this.data.sortColumn}"] i`);
      if (activeHeader) {
        const iconName = this.data.sortDirection === 'asc' ? 'chevron-up' : 'chevron-down';
        activeHeader.setAttribute('data-lucide', iconName);
        activeHeader.className = 'w-4 h-4 text-teal-700';
      }

      if (window.lucide?.createIcons) {
        window.lucide.createIcons();
      }
    },

    renderTable() {
      const tbody = document.getElementById('skuTableBody');
      const tableContainer = document.getElementById('skuTableContainer');
      const emptyState = document.getElementById('emptyState');

      if (this.data.filteredData.length === 0) {
        tableContainer.classList.add('hidden');
        emptyState.classList.remove('hidden');
        return;
      }

      tableContainer.classList.remove('hidden');
      emptyState.classList.add('hidden');

      // Calculate pagination
      const totalItems = this.data.filteredData.length;
      const totalPages = Math.ceil(totalItems / this.data.itemsPerPage);
      const startIndex = (this.data.currentPage - 1) * this.data.itemsPerPage;
      const endIndex = Math.min(startIndex + this.data.itemsPerPage, totalItems);
      const pageData = this.data.filteredData.slice(startIndex, endIndex);

      // Render table rows
      tbody.innerHTML = '';
      pageData.forEach(sku => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 cursor-pointer';
        row.addEventListener('click', () => {
          window.location.href = `sku_detail.html?id=${sku.id}`;
        });

        row.innerHTML = `
          <td class="px-4 py-3 text-sm font-medium text-slate-900">${sku.skuCode}</td>
          <td class="px-4 py-3 text-sm text-slate-700">${sku.productName}</td>
          <td class="px-4 py-3 text-sm text-slate-600">
            <span class="inline-flex px-2 py-1 text-xs font-medium bg-slate-100 text-slate-700 rounded-full">
              ${sku.category}
            </span>
          </td>
          <td class="px-4 py-3 text-sm text-slate-900 text-right font-medium">${sku.totalQuantity.toLocaleString()}</td>
          <td class="px-4 py-3 text-sm text-slate-700 text-right">${sku.totalTransactions}</td>
          <td class="px-4 py-3 text-sm text-slate-700 text-right">${sku.storesCount}</td>
          <td class="px-4 py-3 text-sm text-slate-700 text-right">${sku.avgQuantity}</td>
          <td class="px-4 py-3 text-sm text-slate-600 text-right">${sku.lastSaleDate === 'Never' ? 'Never' : new Date(sku.lastSaleDate).toLocaleDateString('en-GB')}</td>
        `;
        tbody.appendChild(row);
      });

      // Update pagination info
      document.getElementById('paginationInfo').textContent = `${startIndex + 1} - ${endIndex} of ${totalItems}`;

      // Update pagination buttons
      document.getElementById('prevPage').disabled = this.data.currentPage === 1;
      document.getElementById('nextPage').disabled = this.data.currentPage === totalPages;

      // Update page numbers
      this.renderPageNumbers(totalPages);
    },

    renderPageNumbers(totalPages) {
      const pageNumbersEl = document.getElementById('pageNumbers');
      pageNumbersEl.innerHTML = '';

      if (totalPages <= 1) return;

      const current = this.data.currentPage;
      const showPages = [];

      // Always show first page
      showPages.push(1);

      // Show pages around current page
      for (let i = Math.max(2, current - 1); i <= Math.min(totalPages - 1, current + 1); i++) {
        showPages.push(i);
      }

      // Always show last page if more than 1 page
      if (totalPages > 1) showPages.push(totalPages);

      // Remove duplicates and sort
      const uniquePages = [...new Set(showPages)].sort((a, b) => a - b);

      uniquePages.forEach((page, index) => {
        // Add ellipsis if there's a gap
        if (index > 0 && page - uniquePages[index - 1] > 1) {
          const ellipsis = document.createElement('span');
          ellipsis.className = 'px-2 py-1 text-sm text-slate-500';
          ellipsis.textContent = '...';
          pageNumbersEl.appendChild(ellipsis);
        }

        const pageBtn = document.createElement('button');
        pageBtn.className = `px-3 py-1 text-sm border rounded ${
          page === current
            ? 'bg-teal-700 text-white border-teal-700'
            : 'border-slate-200 hover:bg-white focus:outline-none focus:ring-2 focus:ring-teal-500 focus:ring-offset-2'
        }`;
        pageBtn.textContent = page;
        pageBtn.addEventListener('click', () => {
          this.data.currentPage = page;
          this.renderTable();
        });
        pageNumbersEl.appendChild(pageBtn);
      });
    },

    showExportModal() {
      document.getElementById('exportModal').classList.remove('hidden');
      this.updateExportSummary();
    },

    hideExportModal() {
      document.getElementById('exportModal').classList.add('hidden');
      document.getElementById('exportError').classList.add('hidden');
    },

    updateFileNamePreview() {
      const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'csv';
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('fileNamePreview').textContent = `sku_performance_${today}.${format}`;
    },

    updateExportSummary() {
      const includeFiltered = document.getElementById('includeFiltered').checked;
      const count = includeFiltered ? this.data.filteredData.length : this.data.processedData.length;
      const summaryEl = document.getElementById('exportSummary');
      summaryEl.textContent = `Ready to export ${count} SKU${count !== 1 ? 's' : ''} with performance data`;
    },

    performExport() {
      try {
        const format = document.querySelector('input[name="exportFormat"]:checked')?.value || 'csv';
        const includeFiltered = document.getElementById('includeFiltered').checked;
        const dataToExport = includeFiltered ? this.data.filteredData : this.data.processedData;

        let content, mimeType, filename;
        const today = new Date().toISOString().split('T')[0];

        if (format === 'csv') {
          content = this.generateCSV(dataToExport);
          mimeType = 'text/csv;charset=utf-8;';
          filename = `sku_performance_${today}.csv`;
        } else {
          content = JSON.stringify(dataToExport, null, 2);
          mimeType = 'application/json;charset=utf-8;';
          filename = `sku_performance_${today}.json`;
        }

        // Create and trigger download
        const blob = new Blob([content], { type: mimeType });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);

        this.hideExportModal();
      } catch (error) {
        console.error('Export failed:', error);
        document.getElementById('exportError').classList.remove('hidden');
      }
    },

    generateCSV(data) {
      const headers = [
        'SKU Code',
        'Product Name',
        'Category',
        'Status',
        'Unit Price',
        'Total Quantity Sold',
        'Total Transactions',
        'Number of Stores',
        'Average Quantity per Transaction',
        'Last Sale Date'
      ];

      const rows = data.map(sku => [
        sku.skuCode,
        sku.productName,
        sku.category,
        sku.status,
        sku.unitPrice,
        sku.totalQuantity,
        sku.totalTransactions,
        sku.storesCount,
        sku.avgQuantity,
        sku.lastSaleDate
      ]);

      const csvContent = [headers, ...rows]
        .map(row => row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(','))
        .join('\n');

      return csvContent;
    },

    showLoading() {
      document.getElementById('loadingSpinner').classList.remove('hidden');
      document.getElementById('skuTableContainer').classList.add('hidden');
      document.getElementById('emptyState').classList.add('hidden');
    },

    hideLoading() {
      document.getElementById('loadingSpinner').classList.add('hidden');
    }
  };

  // Initialize the SKU Performance Manager
  SKUPerformanceManager.init();
});
</script></body></html>