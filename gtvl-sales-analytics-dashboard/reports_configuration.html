<html lang="en"><head>
    <meta charset="UTF-8">
    <title>Sales Analytics Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style type="text/tailwindcss">
      @theme {
        --color-primary: #0F766E;
        --color-primary-hover: #0D9488;
        --color-secondary: #475569;
        --color-accent: #D97706;
        --color-background: #F8FAFC;
        --color-surface: #FFFFFF;
        --color-surface-variant: #F1F5F9;
        --color-on-background: #0F172A;
        --color-on-surface: #1E293B;
        --color-border: #E2E8F0;
        --color-success: #16A34A;
        --color-warning: #F59E0B;
        --color-error: #DC2626;
        --color-info: #2563EB;
        --header-height: 4rem;
        --sidebar-width: 16rem;
      }

      html {
        scroll-behavior: smooth;
      }

      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9;
      }
      ::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
      }

      .app-header {
        height: var(--header-height);
      }
      .app-sidebar {
        top: var(--header-height);
        width: var(--sidebar-width);
        height: calc(100vh - var(--header-height));
      }
      .app-main {
        margin-top: var(--header-height);
        min-height: calc(100vh - var(--header-height));
      }
      @media (min-width: 768px) {
        .app-main {
          margin-left: var(--sidebar-width);
        }
      }

      @media (max-width: 767px) {
        .app-sidebar {
          left: calc(-1 * var(--sidebar-width));
          transition: left 0.3s ease-in-out;
        }
        .app-sidebar.open {
          left: 0;
        }
      }

      .nav-link.active {
        border-left: 3px solid var(--color-primary);
        padding-left: calc(1rem - 3px);
      }

      .popover {
        opacity: 0;
        visibility: hidden;
        transform: translateY(-8px);
        transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out,
          visibility 0.2s ease-in-out;
      }
      .popover.visible {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .sidebar-backdrop {
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
      }
      .sidebar-backdrop.active {
        opacity: 1;
        visibility: visible;
      }
    </style>
  <title>Generate Sales Report - Reports Configuration</title></head>
  <body class="bg-slate-50 text-slate-800 overflow-x-hidden">
    <header class="app-header fixed top-0 left-0 right-0 bg-white border-b border-slate-200 z-40">
      <div class="h-full max-w-[1920px] mx-auto px-4 md:px-6 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <button id="mobileMenuToggle" class="flex items-center justify-center w-10 h-10 rounded text-slate-600 hover:bg-slate-100 hover:text-slate-900 transition-all duration-200 cursor-pointer border-0 bg-transparent md:hidden focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="Toggle navigation menu" aria-expanded="false">
            <i data-lucide="menu" class="w-6 h-6"></i>
          </button>

          <div class="flex items-center gap-3">
            <div class="w-8 h-8 flex items-center justify-center">
              <svg width="32" height="32" viewBox="0 0 400 400" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="68" y="68" width="264" height="264" rx="32" stroke="#0F766E" stroke-width="18"></rect>
                <rect x="109" y="143" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="109" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="143" width="71" height="33" rx="8" fill="#D97706"></rect>
                <rect x="206" y="194" width="71" height="33" rx="8" fill="#0F766E"></rect>
                <rect x="206" y="245" width="71" height="33" rx="8" fill="#0F766E"></rect>
              </svg>
            </div>
            <h1 class="text-lg md:text-xl font-bold text-slate-900">Sales Analytics Dashboard</h1>
          </div>
        </div>

        <div class="flex items-center gap-2 md:gap-3">
          <button id="userProfileButton" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-transparent hover:bg-slate-50 hover:border-slate-200 transition-all duration-200 cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="User profile menu" aria-expanded="false" aria-haspopup="true">
            <div id="userAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
            <div class="hidden sm:flex flex-col items-start">
              <div id="userName" class="text-sm font-medium text-slate-900"></div>
            </div>
            <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 hidden sm:block"></i>
          </button>
        </div>
      </div>
    </header>

    <div id="userProfilePopover" class="popover absolute top-[4.5rem] right-4 md:right-6 w-72 bg-white border border-slate-200 rounded-lg shadow-xl z-50" role="dialog" aria-labelledby="popoverUserName" data-portal="body">
      <div class="p-4">
        <div class="flex items-center gap-3 pb-3 mb-3 border-b border-slate-100">
          <div id="popoverUserAvatar" class="w-8 h-8 bg-teal-700 text-white rounded-full flex items-center justify-center text-sm font-semibold shrink-0"></div>
          <div class="flex-1 min-w-0">
            <div id="popoverUserName" class="font-semibold text-slate-900 truncate"></div>
            <div id="popoverUserEmail" class="text-xs text-slate-600 truncate"></div>
          </div>
        </div>

        <div class="space-y-1">
          <button id="signOutButton" class="w-full flex items-center gap-3 px-3 py-2 text-sm font-medium text-red-600 hover:bg-red-50 rounded-md transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2">
            <i data-lucide="log-out" class="w-4 h-4"></i>
            Sign Out
          </button>
        </div>
      </div>
    </div>

    <div id="sidebarBackdrop" class="sidebar-backdrop fixed inset-0 bg-black/50 z-20 md:hidden" style="top: var(--header-height)"></div>

    <aside id="sidebar" class="app-sidebar fixed left-0 bg-white border-r border-slate-200 overflow-y-auto z-30 transition-transform duration-300 ease-in-out">
      <nav class="p-4" role="navigation" aria-label="Main navigation">
        <div class="py-6 border-b border-slate-100 first:pt-0 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Analytics</div>
          <div class="space-y-1">
            <a href="dashboard.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline active bg-teal-50 text-teal-700" data-page="dashboard">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
              <span>Dashboard</span>
            </a>
            <a href="sku_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="sku_performance">
              <i data-lucide="package" class="w-5 h-5"></i>
              <span>SKU Performance</span>
            </a>
            <a href="store_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="store_performance">
              <i data-lucide="store" class="w-5 h-5"></i>
              <span>Store Performance</span>
            </a>
            <a href="staff_performance_list.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="staff_performance">
              <i data-lucide="users" class="w-5 h-5"></i>
              <span>Staff Performance</span>
            </a>
            <a href="transaction_history.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="transaction_history">
              <i data-lucide="receipt" class="w-5 h-5"></i>
              <span>Transaction History</span>
            </a>
          </div>
        </div>

        <div class="py-6 border-b border-slate-100 last:border-b-0">
          <div class="px-4 pb-2 text-xs font-semibold uppercase tracking-wider text-slate-500">Tools</div>
          <div class="space-y-1">
            <a href="reports_configuration.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="reports">
              <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
              <span>Reports</span>
            </a>
            <a href="settings.html" class="nav-link flex items-center gap-3 px-4 py-3 text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 rounded-lg transition-all duration-200 no-underline" data-page="settings">
              <i data-lucide="settings" class="w-5 h-5"></i>
              <span>Settings</span>
            </a>
          </div>
        </div>
      </nav>
    </aside>

    <main class="app-main p-6" id="pageContent" role="main"><div class="bg-white border-b border-slate-200 mb-6">
  <div class="flex items-center gap-2 text-sm text-slate-600">
    <a href="dashboard.html" class="hover:text-teal-700 transition-colors duration-200">Dashboard</a>
    <i data-lucide="chevron-right" class="w-4 h-4"></i>
    <span class="text-slate-900 font-medium">Reports</span>
  </div>
</div>

<!-- Page Header -->
<div class="flex items-center justify-between mb-6">
  <div class="flex items-center gap-4">
    <h1 class="text-[1.75rem] leading-[2.25rem] font-bold text-slate-900">Generate Sales Report</h1>
    <button id="helpButton" class="flex items-center justify-center w-8 h-8 rounded-full bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-slate-700 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" title="Report Configuration Guide" aria-label="Open help guide">
      <i data-lucide="help-circle" class="w-4 h-4"></i>
    </button>
  </div>
</div>

<!-- Main Content Layout -->
<div class="flex flex-col lg:flex-row gap-6">
  <!-- Left Sidebar - Report Categories -->
  <div class="lg:w-64 flex-shrink-0">
    <div class="bg-white rounded-lg border border-slate-200 p-4">
      <h3 class="font-semibold text-slate-900 mb-4">Report Categories</h3>
      <div class="space-y-1" id="reportCategories">
        <button class="report-category w-full text-left px-3 py-2 rounded text-sm font-medium transition-all duration-200 bg-teal-50 text-teal-700 border-l-3 border-teal-700" data-category="sales-summary">
          Sales Summary Reports
        </button>
        <button class="report-category w-full text-left px-3 py-2 rounded text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 transition-all duration-200" data-category="sku-analysis">
          SKU Analysis Reports
        </button>
        <button class="report-category w-full text-left px-3 py-2 rounded text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 transition-all duration-200" data-category="store-analysis">
          Store Analysis Reports
        </button>
        <button class="report-category w-full text-left px-3 py-2 rounded text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 transition-all duration-200" data-category="staff-performance">
          Staff Performance Reports
        </button>
        <button class="report-category w-full text-left px-3 py-2 rounded text-sm font-medium text-slate-700 hover:bg-slate-100 hover:text-teal-700 transition-all duration-200" data-category="custom-builder">
          Custom Report Builder
        </button>
      </div>
    </div>
  </div>

  <!-- Main Configuration Form -->
  <div class="flex-1">
    <form id="reportForm" class="bg-white rounded-lg border border-slate-200 p-6 space-y-6">
      
      <!-- Report Type Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Report Type</label>
        <div id="reportTypeOptions" class="space-y-2">
          <!-- Dynamic options based on selected category -->
        </div>
      </div>

      <!-- Date Range Section -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Date Range</label>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" data-range="today">Today</button>
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" data-range="last7days">Last 7 Days</button>
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" data-range="last30days">Last 30 Days</button>
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" data-range="thismonth">This Month</button>
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" data-range="lastmonth">Last Month</button>
          <button type="button" class="date-quick-select px-3 py-2 text-xs font-medium border border-slate-200 rounded hover:bg-slate-50 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2 active bg-teal-50 text-teal-700 border-teal-200" data-range="custom">Custom Range</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Start Date</label>
            <input type="date" id="startDate" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">End Date</label>
            <input type="date" id="endDate" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
          </div>
        </div>
        <div class="mt-2 text-xs text-slate-600" id="dateRangeDisplay">
          Select a date range to continue
        </div>
      </div>

      <!-- Grouping Dimensions -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Primary Grouping</label>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
          <label class="flex items-center">
            <input type="radio" name="primaryGrouping" value="date" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">By Date</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="primaryGrouping" value="sku" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">By SKU</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="primaryGrouping" value="store" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">By Store</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="primaryGrouping" value="staff" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">By Staff</span>
          </label>
          <label class="flex items-center">
            <input type="radio" name="primaryGrouping" value="category" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">By Category</span>
          </label>
        </div>
        
        <div class="mt-4">
          <label class="block text-sm font-semibold text-slate-900 mb-3">Secondary Grouping (Optional)</label>
          <select id="secondaryGrouping" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
            <option value="">None</option>
            <option value="date">By Date</option>
            <option value="sku">By SKU</option>
            <option value="store">By Store</option>
            <option value="staff">By Staff</option>
            <option value="category">By Category</option>
          </select>
        </div>
      </div>

      <!-- Metrics Selection -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Metrics to Include</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="totalQuantity" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500" checked="">
            <span class="ml-2 text-sm text-slate-700">Total Quantity</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="transactionCount" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">Transaction Count</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="uniqueSkus" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">Unique SKUs</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="uniqueStores" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">Unique Stores</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="uniqueStaff" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">Unique Staff</span>
          </label>
          <label class="flex items-center">
            <input type="checkbox" name="metrics" value="avgQuantity" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
            <span class="ml-2 text-sm text-slate-700">Average Quantity per Transaction</span>
          </label>
        </div>
      </div>

      <!-- Filters Section -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Additional Filters (Optional)</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Specific SKUs</label>
            <select id="skuFilter" multiple="" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200" style="height: 80px;">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Specific Stores</label>
            <select id="storeFilter" multiple="" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200" style="height: 80px;">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Specific Staff</label>
            <select id="staffFilter" multiple="" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200" style="height: 80px;">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Categories</label>
            <select id="categoryFilter" multiple="" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200" style="height: 80px;">
              <!-- Populated dynamically -->
            </select>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Minimum Quantity</label>
            <input type="number" id="minQuantity" min="0" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-1">Maximum Quantity</label>
            <input type="number" id="maxQuantity" min="0" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200">
          </div>
        </div>
      </div>

      <!-- Output Options -->
      <div>
        <label class="block text-sm font-semibold text-slate-900 mb-3">Output Options</label>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-2">Format</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="outputFormat" value="screen" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500" checked="">
                <span class="ml-2 text-sm text-slate-700">View on Screen</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="outputFormat" value="csv" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
                <span class="ml-2 text-sm text-slate-700">Export CSV</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="outputFormat" value="json" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
                <span class="ml-2 text-sm text-slate-700">Export JSON</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-xs font-medium text-slate-700 mb-2">Sort Order</label>
            <select id="sortMetric" class="w-full px-3 py-2 border border-slate-200 rounded text-sm focus:ring-2 focus:ring-teal-500 focus:border-teal-500 transition-all duration-200 mb-2">
              <option value="totalQuantity">Total Quantity</option>
              <option value="transactionCount">Transaction Count</option>
              <option value="name">Name/Date</option>
            </select>
            <div class="space-y-1">
              <label class="flex items-center">
                <input type="radio" name="sortDirection" value="desc" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500" checked="">
                <span class="ml-2 text-sm text-slate-700">Descending</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="sortDirection" value="asc" class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500">
                <span class="ml-2 text-sm text-slate-700">Ascending</span>
              </label>
            </div>
          </div>
        </div>
      </div>

      <!-- Report Preview -->
      <div id="reportPreview" class="bg-slate-50 rounded-lg p-4">
        <h4 class="text-sm font-semibold text-slate-900 mb-2">Report Preview</h4>
        <div class="text-xs text-slate-600" id="previewContent">
          Configure your report options to see a preview of the columns and structure.
        </div>
      </div>

      <!-- Validation Messages -->
      <div id="validationMessages" class="hidden">
        <!-- Error messages will be inserted here -->
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-slate-200">
        <button type="submit" id="generateReportButton" class="flex-1 bg-teal-700 text-white px-6 py-3 rounded-lg text-sm font-semibold hover:bg-teal-600 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
          <span class="flex items-center justify-center gap-2">
            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
            Generate Report
          </span>
        </button>
        <button type="button" id="resetFormButton" class="px-6 py-3 border border-slate-200 text-slate-700 rounded-lg text-sm font-semibold hover:bg-slate-50 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2 transition-all duration-200">
          Reset Form
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" data-portal="body" class="fixed inset-0 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4 bg-black/50">
    <div class="bg-white rounded-xl shadow-xl w-[min(92vw,42rem)] max-h-[90vh] overflow-y-auto">
      <!-- Modal Header -->
      <div class="flex items-center justify-between p-6 border-b border-slate-200">
        <h2 class="text-[1.25rem] leading-[1.75rem] font-semibold text-slate-900">Report Configuration Guide</h2>
        <button id="closeHelpModal" class="flex items-center justify-center w-8 h-8 rounded-full text-slate-400 hover:text-slate-600 hover:bg-slate-100 transition-all duration-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-teal-700 focus-visible:outline-offset-2" aria-label="Close modal">
          <i data-lucide="x" class="w-4 h-4"></i>
        </button>
      </div>

      <!-- Modal Tabs -->
      <div class="border-b border-slate-200">
        <div class="flex overflow-x-auto" id="helpTabs">
          <button class="help-tab flex-shrink-0 px-4 py-3 text-sm font-medium transition-all duration-200 border-b-2 border-teal-700 text-teal-700 active" data-tab="overview">Overview</button>
          <button class="help-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 transition-all duration-200 border-b-2 border-transparent" data-tab="report-types">Report Types</button>
          <button class="help-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 transition-all duration-200 border-b-2 border-transparent" data-tab="grouping">Grouping Options</button>
          <button class="help-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 transition-all duration-200 border-b-2 border-transparent" data-tab="metrics">Metrics Guide</button>
          <button class="help-tab flex-shrink-0 px-4 py-3 text-sm font-medium text-slate-600 hover:text-slate-900 transition-all duration-200 border-b-2 border-transparent" data-tab="best-practices">Best Practices</button>
        </div>
      </div>

      <!-- Tab Content -->
      <div class="p-6">
        <div id="tab-overview" class="help-tab-content">
          <h3 class="font-semibold text-slate-900 mb-3">Report Generation Process</h3>
          <p class="text-sm text-slate-600 mb-4">This tool helps you create customized sales reports by configuring various parameters to analyze your data from different perspectives.</p>
          <div class="space-y-3">
            <div class="flex items-start gap-3">
              <div class="w-6 h-6 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center text-xs font-semibold mt-0.5">1</div>
              <div>
                <p class="text-sm font-medium text-slate-900">Select Report Category</p>
                <p class="text-xs text-slate-600">Choose the type of analysis you want to perform</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-6 h-6 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center text-xs font-semibold mt-0.5">2</div>
              <div>
                <p class="text-sm font-medium text-slate-900">Configure Date Range</p>
                <p class="text-xs text-slate-600">Set the time period for your analysis</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-6 h-6 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center text-xs font-semibold mt-0.5">3</div>
              <div>
                <p class="text-sm font-medium text-slate-900">Choose Grouping &amp; Metrics</p>
                <p class="text-xs text-slate-600">Decide how to organize and measure your data</p>
              </div>
            </div>
            <div class="flex items-start gap-3">
              <div class="w-6 h-6 bg-teal-100 text-teal-700 rounded-full flex items-center justify-center text-xs font-semibold mt-0.5">4</div>
              <div>
                <p class="text-sm font-medium text-slate-900">Apply Filters &amp; Generate</p>
                <p class="text-xs text-slate-600">Refine your results and choose output format</p>
              </div>
            </div>
          </div>
        </div>

        <div id="tab-report-types" class="help-tab-content hidden">
          <h3 class="font-semibold text-slate-900 mb-3">Available Report Types</h3>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Sales Summary Reports</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• <strong>Sales by Date Range:</strong> Overall sales performance over time</li>
                <li>• <strong>Daily Sales Summary:</strong> Day-by-day breakdown of sales activity</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">SKU Analysis Reports</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• <strong>Top Performing SKUs:</strong> Best-selling products by quantity</li>
                <li>• <strong>SKU Performance by Store:</strong> Product performance across locations</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Store Analysis Reports</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• <strong>Store Comparison:</strong> Performance metrics across all stores</li>
                <li>• <strong>Store Daily Performance:</strong> Individual store performance over time</li>
              </ul>
            </div>
          </div>
        </div>

        <div id="tab-grouping" class="help-tab-content hidden">
          <h3 class="font-semibold text-slate-900 mb-3">Understanding Grouping Options</h3>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Primary Grouping</h4>
              <p class="text-sm text-slate-600 mb-2">Determines the main dimension for organizing your report:</p>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• <strong>By Date:</strong> Group results by time periods</li>
                <li>• <strong>By SKU:</strong> Group results by individual products</li>
                <li>• <strong>By Store:</strong> Group results by store location</li>
                <li>• <strong>By Staff:</strong> Group results by individual staff members</li>
                <li>• <strong>By Category:</strong> Group results by product categories</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Secondary Grouping</h4>
              <p class="text-sm text-slate-600">Optional cross-tabulation to create more detailed breakdowns (e.g., SKUs by Store shows which products perform best at each location).</p>
            </div>
          </div>
        </div>

        <div id="tab-metrics" class="help-tab-content hidden">
          <h3 class="font-semibold text-slate-900 mb-3">Available Metrics</h3>
          <div class="space-y-3">
            <div class="bg-slate-50 p-3 rounded">
              <h4 class="font-medium text-slate-900 mb-1">Total Quantity</h4>
              <p class="text-sm text-slate-600">Sum of all quantities sold for the grouped items</p>
            </div>
            <div class="bg-slate-50 p-3 rounded">
              <h4 class="font-medium text-slate-900 mb-1">Transaction Count</h4>
              <p class="text-sm text-slate-600">Number of individual sales transactions</p>
            </div>
            <div class="bg-slate-50 p-3 rounded">
              <h4 class="font-medium text-slate-900 mb-1">Unique Counts</h4>
              <p class="text-sm text-slate-600">Count of distinct SKUs, stores, or staff involved</p>
            </div>
            <div class="bg-slate-50 p-3 rounded">
              <h4 class="font-medium text-slate-900 mb-1">Average Quantity</h4>
              <p class="text-sm text-slate-600">Average quantity per transaction (useful for understanding purchase patterns)</p>
            </div>
          </div>
        </div>

        <div id="tab-best-practices" class="help-tab-content hidden">
          <h3 class="font-semibold text-slate-900 mb-3">Tips for Effective Reports</h3>
          <div class="space-y-4">
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Choosing Date Ranges</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• Use "Last 7 Days" for recent trend analysis</li>
                <li>• Use "This Month" vs "Last Month" for period comparisons</li>
                <li>• Custom ranges work best for specific campaigns or events</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Effective Grouping</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• Group by Date for time-series analysis</li>
                <li>• Group by SKU to identify top performers</li>
                <li>• Use secondary grouping for deeper insights</li>
              </ul>
            </div>
            <div>
              <h4 class="font-medium text-slate-900 mb-2">Using Filters</h4>
              <ul class="text-sm text-slate-600 space-y-1 ml-4">
                <li>• Filter by specific stores to compare locations</li>
                <li>• Set quantity thresholds to focus on significant sales</li>
                <li>• Combine filters for targeted analysis</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

</main>

    <script src="app.js"></script>
    <script src="app_data.js"></script>
    <script id="container-script">
      (function () {
        const TemplateUtils = (window.TemplateUtils = window.TemplateUtils || {});

        TemplateUtils.UserUtils =
          TemplateUtils.UserUtils ||
          (function createUserUtils() {
            return {
              getCurrentUser() {
                try {
                  let currentUserId = localStorage.getItem("currentUserId");
                  if (!currentUserId) {
                    localStorage.setItem("currentUserId", "usr_sales_001");
                    currentUserId = "usr_sales_001";
                  }

                  const users = JSON.parse(localStorage.getItem("users") || "[]");
                  return users.find(user => user.id === currentUserId) || null;
                } catch (error) {
                  console.error("Error retrieving user data:", error);
                  return null;
                }
              },
              signOut() {
                try {
                  localStorage.removeItem("currentUserId");
                  window.location.reload();
                } catch (error) {
                  console.error("Error signing out:", error);
                }
              },
              getUserDisplayName(user) {
                if (!user) return "Guest";
                return user.firstName && user.lastName
                  ? `${user.firstName} ${user.lastName}`
                  : user.firstName || user.lastName || "User";
              },
              getUserInitials(user) {
                if (!user) return "?";
                const first = user.firstName?.charAt(0) || "";
                const last = user.lastName?.charAt(0) || "";
                return (first + last).toUpperCase() || "U";
              },
            };
          })();

        if (TemplateUtils.__bootstrapped) {
          if (typeof window.lucide?.createIcons === "function") {
            window.lucide.createIcons();
          }
          return;
        }

        TemplateUtils.__bootstrapped = true;

        const state = {
          popoverVisible: false,
          sidebarOpen: false,
          resizeTimer: null,
          observerFrame: null,
          refs: {},
        };

        function ready(fn) {
          if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", fn, { once: true });
          } else if (typeof queueMicrotask === "function") {
            queueMicrotask(fn);
          } else {
            Promise.resolve().then(fn);
          }
        }

        function safeLucide(callback) {
          if (typeof window.lucide?.createIcons === "function") {
            callback();
          }
        }

        function cacheRefs() {
          state.refs = {
            userProfileButton: document.getElementById("userProfileButton"),
            userProfilePopover: document.getElementById("userProfilePopover"),
            userAvatar: document.getElementById("userAvatar"),
            userName: document.getElementById("userName"),
            popoverUserAvatar: document.getElementById("popoverUserAvatar"),
            popoverUserName: document.getElementById("popoverUserName"),
            popoverUserEmail: document.getElementById("popoverUserEmail"),
            signOutButton: document.getElementById("signOutButton"),
            mobileMenuToggle: document.getElementById("mobileMenuToggle"),
            sidebar: document.getElementById("sidebar"),
            sidebarBackdrop: document.getElementById("sidebarBackdrop"),
            navLinks: document.querySelectorAll(".nav-link"),
            pageContent: document.getElementById("pageContent"),
          };
        }

        function initializeUserProfile() {
          const { userAvatar, userName } = state.refs;
          if (!userAvatar || !userName) return;

          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          if (currentUser) {
            userAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            userName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
          } else {
            userAvatar.textContent = "?";
            userName.textContent = "Guest";
          }
        }

        function populatePopover() {
          const currentUser = TemplateUtils.UserUtils.getCurrentUser();
          const { popoverUserAvatar, popoverUserName, popoverUserEmail } = state.refs;
          if (!popoverUserAvatar || !popoverUserName || !popoverUserEmail) return;

          if (currentUser) {
            popoverUserAvatar.textContent = TemplateUtils.UserUtils.getUserInitials(currentUser);
            popoverUserName.textContent = TemplateUtils.UserUtils.getUserDisplayName(currentUser);
            popoverUserEmail.textContent = currentUser.email || "No email";
          } else {
            popoverUserAvatar.textContent = "?";
            popoverUserName.textContent = "Guest";
            popoverUserEmail.textContent = "Not logged in";
          }
        }

        function toggleUserPopover(forceClose = false) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (!userProfilePopover || !userProfileButton) return;

          const shouldOpen = forceClose ? false : !state.popoverVisible;
          if (shouldOpen) {
            populatePopover();
            userProfilePopover.classList.add("visible");
            userProfileButton.setAttribute("aria-expanded", "true");
            state.popoverVisible = true;
            const firstButton = userProfilePopover.querySelector("button");
            if (firstButton) {
              setTimeout(() => firstButton.focus(), 50);
            }
          } else {
            userProfilePopover.classList.remove("visible");
            userProfileButton.setAttribute("aria-expanded", "false");
            state.popoverVisible = false;
          }
        }

        function hideUserPopover() {
          if (state.popoverVisible) {
            toggleUserPopover(true);
          }
        }

        function toggleMobileSidebar(forceClose = false) {
          const { sidebar, sidebarBackdrop, mobileMenuToggle } = state.refs;
          if (!sidebar || !sidebarBackdrop || !mobileMenuToggle) return;

          const shouldOpen = forceClose ? false : !state.sidebarOpen;
          state.sidebarOpen = shouldOpen;

          sidebar.classList.toggle("open", shouldOpen);
          sidebarBackdrop.classList.toggle("active", shouldOpen);
          mobileMenuToggle.setAttribute("aria-expanded", shouldOpen ? "true" : "false");
          document.body.style.overflow = shouldOpen ? "hidden" : "";
        }

        function closeMobileSidebar() {
          if (state.sidebarOpen) {
            toggleMobileSidebar(true);
          }
        }

        function setActiveNavLink(pageId) {
          if (!pageId) return;
          const { navLinks } = state.refs;
          navLinks?.forEach((link) => {
            if (link.dataset.page === pageId) {
              link.classList.add("active", "bg-teal-50", "text-teal-700");
            } else {
              link.classList.remove("active", "bg-teal-50", "text-teal-700");
            }
          });
        }

        TemplateUtils.setActiveNavLink = setActiveNavLink;
        TemplateUtils.closeMobileSidebar = closeMobileSidebar;

        function handleDocumentClick(event) {
          const { userProfilePopover, userProfileButton } = state.refs;
          if (
            state.popoverVisible &&
            userProfilePopover &&
            userProfileButton &&
            !userProfilePopover.contains(event.target) &&
            !userProfileButton.contains(event.target)
          ) {
            hideUserPopover();
          }
        }

        function handleKeydown(event) {
          if (event.key !== "Escape") return;
          if (state.popoverVisible) {
            hideUserPopover();
            state.refs.userProfileButton?.focus();
          }
          if (state.sidebarOpen) {
            closeMobileSidebar();
            state.refs.mobileMenuToggle?.focus();
          }
        }

        function handleResize() {
          clearTimeout(state.resizeTimer);
          state.resizeTimer = setTimeout(() => {
            if (window.innerWidth >= 768) {
              closeMobileSidebar();
            }
          }, 200);
        }

        function bindEvents() {
          const {
            userProfileButton,
            mobileMenuToggle,
            sidebarBackdrop,
            signOutButton,
            navLinks,
          } = state.refs;

          userProfileButton?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleUserPopover();
          });

          mobileMenuToggle?.addEventListener("click", (event) => {
            event.stopPropagation();
            toggleMobileSidebar();
          });

          sidebarBackdrop?.addEventListener("click", () => closeMobileSidebar());

          signOutButton?.addEventListener("click", () => {
            if (confirm("Are you sure you want to sign out?")) {
              TemplateUtils.UserUtils.signOut();
            }
          });

          navLinks?.forEach((link) => {
            link.addEventListener("click", () => closeMobileSidebar());
          });

          document.addEventListener("click", handleDocumentClick);
          document.addEventListener("keydown", handleKeydown);
          window.addEventListener("resize", handleResize);
        }

        function initializePortalTargets() {
          document.querySelectorAll('[data-portal="body"]').forEach((node) => {
            if (node.parentElement !== document.body) {
              document.body.appendChild(node);
            }
          });
        }

        function observePageContent() {
          const { pageContent } = state.refs;
          if (!pageContent || typeof MutationObserver !== "function") return;

          const observer = new MutationObserver(() => {
            if (state.observerFrame) return;
            state.observerFrame = requestAnimationFrame(() => {
              state.observerFrame = null;
              safeLucide(() => window.lucide.createIcons());
            });
          });

          observer.observe(pageContent, { childList: true, subtree: true });
          state.observer = observer;
        }

        function bootstrap() {
          cacheRefs();
          initializePortalTargets();
          initializeUserProfile();
          bindEvents();
          safeLucide(() => window.lucide.createIcons());
          observePageContent();
        }

        ready(bootstrap);
      })();
    </script>
  

<script>
// Utility: portal a modal by id (idempotent)
function funPortalModalToBody(id){
  const el = document.getElementById(id);
  if (el && el.parentElement !== document.body) document.body.appendChild(el);
}

document.addEventListener('DOMContentLoaded', () => {
  // Auto-portal any modal declaring data-portal="body"
  document.querySelectorAll('[data-portal="body"]').forEach(el => {
    if (el.parentElement !== document.body) document.body.appendChild(el);
  });

  // Set active navigation
  if (typeof TemplateUtils !== 'undefined' && TemplateUtils.setActiveNavLink) {
    TemplateUtils.setActiveNavLink('reports');
  }

  // Initialize the reports configuration functionality
  funInitializeReportsConfiguration();
});

function funInitializeReportsConfiguration() {
  // Load data from localStorage
  const skus = JSON.parse(localStorage.getItem('skus') || '[]');
  const stores = JSON.parse(localStorage.getItem('stores') || '[]');
  const users = JSON.parse(localStorage.getItem('users') || '[]');
  const salesRecords = JSON.parse(localStorage.getItem('salesRecords') || '[]');

  // Get unique categories
  const categories = [...new Set(skus.map(sku => sku.category))];
  
  // Get staff users (promodizers and supervisors)
  const staffUsers = users.filter(user => ['promodizer', 'supervisor'].includes(user.role));

  // Report type configurations
  const reportTypes = {
    'sales-summary': [
      { value: 'sales-by-date-range', label: 'Sales by Date Range' },
      { value: 'daily-sales-summary', label: 'Daily Sales Summary' }
    ],
    'sku-analysis': [
      { value: 'top-performing-skus', label: 'Top Performing SKUs' },
      { value: 'sku-performance-by-store', label: 'SKU Performance by Store' }
    ],
    'store-analysis': [
      { value: 'store-comparison', label: 'Store Comparison' },
      { value: 'store-daily-performance', label: 'Store Daily Performance' }
    ],
    'staff-performance': [
      { value: 'staff-productivity', label: 'Staff Productivity' },
      { value: 'staff-sales-comparison', label: 'Staff Sales Comparison' }
    ],
    'custom-builder': [
      { value: 'custom-report', label: 'Custom Report Builder' }
    ]
  };

  // Current state
  let currentState = {
    category: 'sales-summary',
    reportType: 'sales-by-date-range',
    dateRange: 'custom',
    startDate: '',
    endDate: '',
    primaryGrouping: '',
    secondaryGrouping: '',
    metrics: ['totalQuantity'],
    outputFormat: 'screen',
    sortMetric: 'totalQuantity',
    sortDirection: 'desc'
  };

  // Initialize form elements
  const elements = {
    reportCategories: document.getElementById('reportCategories'),
    reportTypeOptions: document.getElementById('reportTypeOptions'),
    startDate: document.getElementById('startDate'),
    endDate: document.getElementById('endDate'),
    dateRangeDisplay: document.getElementById('dateRangeDisplay'),
    skuFilter: document.getElementById('skuFilter'),
    storeFilter: document.getElementById('storeFilter'),
    staffFilter: document.getElementById('staffFilter'),
    categoryFilter: document.getElementById('categoryFilter'),
    reportPreview: document.getElementById('reportPreview'),
    previewContent: document.getElementById('previewContent'),
    validationMessages: document.getElementById('validationMessages'),
    generateReportButton: document.getElementById('generateReportButton'),
    resetFormButton: document.getElementById('resetFormButton'),
    reportForm: document.getElementById('reportForm'),
    helpButton: document.getElementById('helpButton'),
    helpModal: document.getElementById('helpModal'),
    closeHelpModal: document.getElementById('closeHelpModal')
  };

  // Initialize default date range (last 7 days)
  const today = new Date();
  const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
  elements.endDate.value = today.toISOString().split('T')[0];
  elements.startDate.value = sevenDaysAgo.toISOString().split('T')[0];
  currentState.startDate = elements.startDate.value;
  currentState.endDate = elements.endDate.value;

  // Populate filter dropdowns
  funPopulateFilterOptions();

  // Load saved configuration
  funLoadSavedConfiguration();

  // Set up event listeners
  funSetupEventListeners();

  // Initialize report type options
  funUpdateReportTypeOptions();

  // Initialize preview
  funUpdateReportPreview();

  // Update date range display
  funUpdateDateRangeDisplay();

  function funPopulateFilterOptions() {
    // Populate SKU filter
    elements.skuFilter.innerHTML = '';
    skus.forEach(sku => {
      const option = document.createElement('option');
      option.value = sku.id;
      option.textContent = `${sku.productName} (${sku.skuCode})`;
      elements.skuFilter.appendChild(option);
    });

    // Populate store filter
    elements.storeFilter.innerHTML = '';
    stores.forEach(store => {
      const option = document.createElement('option');
      option.value = store.id;
      option.textContent = `${store.storeName} (${store.storeCode})`;
      elements.storeFilter.appendChild(option);
    });

    // Populate staff filter
    elements.staffFilter.innerHTML = '';
    staffUsers.forEach(user => {
      const option = document.createElement('option');
      option.value = user.id;
      option.textContent = `${user.firstName} ${user.lastName} (${user.role})`;
      elements.staffFilter.appendChild(option);
    });

    // Populate category filter
    elements.categoryFilter.innerHTML = '';
    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      elements.categoryFilter.appendChild(option);
    });
  }

  function funLoadSavedConfiguration() {
    try {
      const saved = localStorage.getItem('reportConfiguration');
      if (saved) {
        const config = JSON.parse(saved);
        Object.assign(currentState, config);
        
        // Apply saved state to form elements
        if (config.startDate) elements.startDate.value = config.startDate;
        if (config.endDate) elements.endDate.value = config.endDate;
        
        // Set grouping
        const primaryGrouping = document.querySelector(`input[name="primaryGrouping"][value="${config.primaryGrouping}"]`);
        if (primaryGrouping) primaryGrouping.checked = true;
        
        // Set secondary grouping
        const secondaryGrouping = document.getElementById('secondaryGrouping');
        if (secondaryGrouping && config.secondaryGrouping) {
          secondaryGrouping.value = config.secondaryGrouping;
        }

        // Set metrics
        document.querySelectorAll('input[name="metrics"]').forEach(checkbox => {
          checkbox.checked = config.metrics.includes(checkbox.value);
        });

        // Set output format
        const outputFormat = document.querySelector(`input[name="outputFormat"][value="${config.outputFormat}"]`);
        if (outputFormat) outputFormat.checked = true;

        // Set sort options
        const sortMetric = document.getElementById('sortMetric');
        if (sortMetric && config.sortMetric) sortMetric.value = config.sortMetric;
        
        const sortDirection = document.querySelector(`input[name="sortDirection"][value="${config.sortDirection}"]`);
        if (sortDirection) sortDirection.checked = true;
      }
    } catch (error) {
      console.error('Error loading saved configuration:', error);
    }
  }

  function funSaveConfiguration() {
    try {
      localStorage.setItem('reportConfiguration', JSON.stringify(currentState));
    } catch (error) {
      console.error('Error saving configuration:', error);
    }
  }

  function funSetupEventListeners() {
    // Report category selection
    elements.reportCategories.addEventListener('click', (e) => {
      if (e.target.classList.contains('report-category')) {
        // Update active category
        document.querySelectorAll('.report-category').forEach(btn => {
          btn.classList.remove('active', 'bg-teal-50', 'text-teal-700', 'border-l-3', 'border-teal-700');
          btn.classList.add('text-slate-700');
        });
        
        e.target.classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-l-3', 'border-teal-700');
        e.target.classList.remove('text-slate-700');
        
        currentState.category = e.target.dataset.category;
        funUpdateReportTypeOptions();
        funSaveConfiguration();
      }
    });

    // Date range quick selects
    document.querySelectorAll('.date-quick-select').forEach(btn => {
      btn.addEventListener('click', (e) => {
        // Update active button
        document.querySelectorAll('.date-quick-select').forEach(b => {
          b.classList.remove('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
        });
        e.target.classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
        
        const range = e.target.dataset.range;
        currentState.dateRange = range;
        
        const { startDate, endDate } = funCalculateDateRange(range);
        if (startDate && endDate) {
          elements.startDate.value = startDate;
          elements.endDate.value = endDate;
          currentState.startDate = startDate;
          currentState.endDate = endDate;
        }
        
        funUpdateDateRangeDisplay();
        funSaveConfiguration();
      });
    });

    // Date inputs
    elements.startDate.addEventListener('change', (e) => {
      currentState.startDate = e.target.value;
      currentState.dateRange = 'custom';
      funUpdateDateRangeDisplay();
      funUpdateReportPreview();
      funSaveConfiguration();
    });

    elements.endDate.addEventListener('change', (e) => {
      currentState.endDate = e.target.value;
      currentState.dateRange = 'custom';
      funUpdateDateRangeDisplay();
      funUpdateReportPreview();
      funSaveConfiguration();
    });

    // Primary grouping
    document.querySelectorAll('input[name="primaryGrouping"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentState.primaryGrouping = e.target.value;
        funUpdateSecondaryGroupingOptions();
        funUpdateReportPreview();
        funSaveConfiguration();
      });
    });

    // Secondary grouping
    document.getElementById('secondaryGrouping').addEventListener('change', (e) => {
      currentState.secondaryGrouping = e.target.value;
      funUpdateReportPreview();
      funSaveConfiguration();
    });

    // Metrics
    document.querySelectorAll('input[name="metrics"]').forEach(checkbox => {
      checkbox.addEventListener('change', () => {
        currentState.metrics = Array.from(document.querySelectorAll('input[name="metrics"]:checked'))
          .map(cb => cb.value);
        funUpdateReportPreview();
        funSaveConfiguration();
      });
    });

    // Output format
    document.querySelectorAll('input[name="outputFormat"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentState.outputFormat = e.target.value;
        funSaveConfiguration();
      });
    });

    // Sort options
    document.getElementById('sortMetric').addEventListener('change', (e) => {
      currentState.sortMetric = e.target.value;
      funSaveConfiguration();
    });

    document.querySelectorAll('input[name="sortDirection"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentState.sortDirection = e.target.value;
        funSaveConfiguration();
      });
    });

    // Form submission
    elements.reportForm.addEventListener('submit', (e) => {
      e.preventDefault();
      funGenerateReport();
    });

    // Reset form
    elements.resetFormButton.addEventListener('click', () => {
      if (confirm('Are you sure you want to reset all form settings?')) {
        funResetForm();
      }
    });

    // Help modal
    elements.helpButton.addEventListener('click', () => {
      elements.helpModal.classList.remove('hidden');
    });

    elements.closeHelpModal.addEventListener('click', () => {
      elements.helpModal.classList.add('hidden');
    });

    // Help modal tabs
    document.querySelectorAll('.help-tab').forEach(tab => {
      tab.addEventListener('click', (e) => {
        const targetTab = e.target.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.help-tab').forEach(t => {
          t.classList.remove('active', 'border-teal-700', 'text-teal-700');
          t.classList.add('border-transparent', 'text-slate-600');
        });
        e.target.classList.add('active', 'border-teal-700', 'text-teal-700');
        e.target.classList.remove('border-transparent', 'text-slate-600');
        
        // Show target content
        document.querySelectorAll('.help-tab-content').forEach(content => {
          content.classList.add('hidden');
        });
        document.getElementById(`tab-${targetTab}`).classList.remove('hidden');
      });
    });

    // Close modal on backdrop click
    elements.helpModal.addEventListener('click', (e) => {
      if (e.target === elements.helpModal) {
        elements.helpModal.classList.add('hidden');
      }
    });

    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !elements.helpModal.classList.contains('hidden')) {
        elements.helpModal.classList.add('hidden');
      }
    });
  }

  function funUpdateReportTypeOptions() {
    const options = reportTypes[currentState.category] || [];
    elements.reportTypeOptions.innerHTML = '';
    
    options.forEach((option, index) => {
      const div = document.createElement('div');
      div.className = 'flex items-center';
      div.innerHTML = `
        <input 
          type="radio" 
          name="reportType" 
          value="${option.value}" 
          id="reportType${index}"
          class="w-4 h-4 text-teal-700 border-slate-300 focus:ring-teal-500"
          ${index === 0 ? 'checked' : ''}
        >
        <label for="reportType${index}" class="ml-2 text-sm text-slate-700">${option.label}</label>
      `;
      elements.reportTypeOptions.appendChild(div);
    });

    // Set default report type
    if (options.length > 0) {
      currentState.reportType = options[0].value;
    }

    // Add event listeners to new radio buttons
    document.querySelectorAll('input[name="reportType"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        currentState.reportType = e.target.value;
        funUpdateReportPreview();
        funSaveConfiguration();
      });
    });
  }

  function funCalculateDateRange(range) {
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];
    
    switch (range) {
      case 'today':
        return { startDate: todayStr, endDate: todayStr };
      case 'last7days':
        const sevenDaysAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        return { startDate: sevenDaysAgo.toISOString().split('T')[0], endDate: todayStr };
      case 'last30days':
        const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
        return { startDate: thirtyDaysAgo.toISOString().split('T')[0], endDate: todayStr };
      case 'thismonth':
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        return { startDate: firstDayOfMonth.toISOString().split('T')[0], endDate: todayStr };
      case 'lastmonth':
        const firstDayOfLastMonth = new Date(today.getFullYear(), today.getMonth() - 1, 1);
        const lastDayOfLastMonth = new Date(today.getFullYear(), today.getMonth(), 0);
        return { 
          startDate: firstDayOfLastMonth.toISOString().split('T')[0], 
          endDate: lastDayOfLastMonth.toISOString().split('T')[0] 
        };
      default:
        return { startDate: null, endDate: null };
    }
  }

  function funUpdateDateRangeDisplay() {
    if (currentState.startDate && currentState.endDate) {
      const start = new Date(currentState.startDate);
      const end = new Date(currentState.endDate);
      const diffTime = Math.abs(end - start);
      const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      
      elements.dateRangeDisplay.textContent = 
        `Selected: ${start.toLocaleDateString()} to ${end.toLocaleDateString()} (${diffDays} days)`;
      elements.dateRangeDisplay.className = 'mt-2 text-xs text-teal-600';
    } else {
      elements.dateRangeDisplay.textContent = 'Select a date range to continue';
      elements.dateRangeDisplay.className = 'mt-2 text-xs text-slate-600';
    }
  }

  function funUpdateSecondaryGroupingOptions() {
    const secondarySelect = document.getElementById('secondaryGrouping');
    const currentPrimary = currentState.primaryGrouping;
    
    // Reset options
    secondarySelect.innerHTML = '<option value="">None</option>';
    
    const allOptions = [
      { value: 'date', label: 'By Date' },
      { value: 'sku', label: 'By SKU' },
      { value: 'store', label: 'By Store' },
      { value: 'staff', label: 'By Staff' },
      { value: 'category', label: 'By Category' }
    ];
    
    // Add options except the primary grouping
    allOptions.forEach(option => {
      if (option.value !== currentPrimary) {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.label;
        secondarySelect.appendChild(optionElement);
      }
    });
  }

  function funUpdateReportPreview() {
    if (!currentState.primaryGrouping || currentState.metrics.length === 0) {
      elements.previewContent.textContent = 'Configure your report options to see a preview of the columns and structure.';
      elements.previewContent.className = 'text-xs text-slate-600';
      return;
    }

    const columns = [];
    
    // Add grouping columns
    if (currentState.primaryGrouping) {
      const groupingLabels = {
        date: 'Date',
        sku: 'SKU Name',
        store: 'Store Name',
        staff: 'Staff Name',
        category: 'Category'
      };
      columns.push(groupingLabels[currentState.primaryGrouping]);
    }
    
    if (currentState.secondaryGrouping) {
      const groupingLabels = {
        date: 'Date',
        sku: 'SKU Name',
        store: 'Store Name',
        staff: 'Staff Name',
        category: 'Category'
      };
      columns.push(groupingLabels[currentState.secondaryGrouping]);
    }

    // Add metric columns
    const metricLabels = {
      totalQuantity: 'Total Quantity',
      transactionCount: 'Transaction Count',
      uniqueSkus: 'Unique SKUs',
      uniqueStores: 'Unique Stores',
      uniqueStaff: 'Unique Staff',
      avgQuantity: 'Avg Quantity'
    };
    
    currentState.metrics.forEach(metric => {
      if (metricLabels[metric]) {
        columns.push(metricLabels[metric]);
      }
    });

    elements.previewContent.innerHTML = `
      <div class="text-xs font-medium text-slate-900 mb-2">Report Columns:</div>
      <div class="flex flex-wrap gap-1">
        ${columns.map(col => `<span class="inline-block px-2 py-1 bg-teal-100 text-teal-700 rounded text-xs font-medium">${col}</span>`).join('')}
      </div>
      <div class="text-xs text-slate-600 mt-2">
        Estimated records: ${funEstimateRecordCount()} • 
        Sort by: ${document.getElementById('sortMetric').selectedOptions[0]?.textContent || 'Total Quantity'} 
        (${currentState.sortDirection === 'desc' ? 'Descending' : 'Ascending'})
      </div>
    `;
    elements.previewContent.className = 'text-xs';
  }

  function funEstimateRecordCount() {
    // Simple estimation based on available data and grouping
    let baseCount = salesRecords.length;
    
    if (currentState.primaryGrouping === 'date') {
      const start = new Date(currentState.startDate);
      const end = new Date(currentState.endDate);
      const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      baseCount = Math.min(baseCount, diffDays);
    } else if (currentState.primaryGrouping === 'sku') {
      baseCount = Math.min(baseCount, skus.length);
    } else if (currentState.primaryGrouping === 'store') {
      baseCount = Math.min(baseCount, stores.length);
    } else if (currentState.primaryGrouping === 'staff') {
      baseCount = Math.min(baseCount, staffUsers.length);
    } else if (currentState.primaryGrouping === 'category') {
      baseCount = Math.min(baseCount, categories.length);
    }

    return baseCount;
  }

  function funValidateForm() {
    const errors = [];

    // Check date range
    if (!currentState.startDate || !currentState.endDate) {
      errors.push('Please select a valid date range.');
    } else if (new Date(currentState.startDate) > new Date(currentState.endDate)) {
      errors.push('Start date must be before or equal to end date.');
    }

    // Check primary grouping
    if (!currentState.primaryGrouping) {
      errors.push('Please select a primary grouping dimension.');
    }

    // Check metrics
    if (currentState.metrics.length === 0) {
      errors.push('Please select at least one metric to include in the report.');
    }

    // Display errors
    if (errors.length > 0) {
      elements.validationMessages.innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <div class="flex items-center gap-2 text-red-800 font-medium mb-2">
            <i data-lucide="alert-circle" class="w-4 h-4"></i>
            Please fix the following issues:
          </div>
          <ul class="text-sm text-red-700 space-y-1">
            ${errors.map(error => `<li>• ${error}</li>`).join('')}
          </ul>
        </div>
      `;
      elements.validationMessages.classList.remove('hidden');
      
      // Re-initialize Lucide icons
      if (typeof lucide !== 'undefined' && lucide.createIcons) {
        lucide.createIcons();
      }
      
      return false;
    }

    elements.validationMessages.classList.add('hidden');
    return true;
  }

  function funGenerateReport() {
    if (!funValidateForm()) {
      return;
    }

    // Collect all form data
    const reportConfig = {
      ...currentState,
      reportType: document.querySelector('input[name="reportType"]:checked')?.value || currentState.reportType,
      filters: {
        skus: Array.from(elements.skuFilter.selectedOptions).map(opt => opt.value),
        stores: Array.from(elements.storeFilter.selectedOptions).map(opt => opt.value),
        staff: Array.from(elements.staffFilter.selectedOptions).map(opt => opt.value),
        categories: Array.from(elements.categoryFilter.selectedOptions).map(opt => opt.value),
        minQuantity: parseInt(document.getElementById('minQuantity').value) || null,
        maxQuantity: parseInt(document.getElementById('maxQuantity').value) || null
      }
    };

    // Handle different output formats
    if (reportConfig.outputFormat === 'screen') {
      // Navigate to report display page
      sessionStorage.setItem('reportConfig', JSON.stringify(reportConfig));
      window.location.href = 'report_display.html';
    } else {
      // Generate and download file
      funExportReport(reportConfig);
    }
  }

  function funExportReport(config) {
    // Generate report data
    const reportData = funGenerateReportData(config);
    
    if (config.outputFormat === 'csv') {
      funExportToCSV(reportData, `sales_report_${new Date().toISOString().split('T')[0]}.csv`);
    } else if (config.outputFormat === 'json') {
      funExportToJSON(reportData, `sales_report_${new Date().toISOString().split('T')[0]}.json`);
    }
  }

  function funGenerateReportData(config) {
    // Filter sales records based on date range and filters
    let filteredRecords = salesRecords.filter(record => {
      const recordDate = new Date(record.recordedAt).toISOString().split('T')[0];
      return recordDate >= config.startDate && recordDate <= config.endDate;
    });

    // Apply additional filters
    if (config.filters.stores.length > 0) {
      filteredRecords = filteredRecords.filter(record => config.filters.stores.includes(record.storeId));
    }

    if (config.filters.staff.length > 0) {
      filteredRecords = filteredRecords.filter(record => config.filters.staff.includes(record.recordedById));
    }

    // Process and group data based on configuration
    // This is a simplified version - full implementation would be more complex
    const groupedData = {};
    
    filteredRecords.forEach(record => {
      record.scannedSkus.forEach(scannedSku => {
        // Apply quantity filters
        if (config.filters.minQuantity && scannedSku.quantity < config.filters.minQuantity) return;
        if (config.filters.maxQuantity && scannedSku.quantity > config.filters.maxQuantity) return;

        const sku = skus.find(s => s.id === scannedSku.skuId);
        if (!sku) return;

        // Apply category filter
        if (config.filters.categories.length > 0 && !config.filters.categories.includes(sku.category)) return;

        // Apply SKU filter
        if (config.filters.skus.length > 0 && !config.filters.skus.includes(sku.id)) return;

        // Generate grouping key
        let groupKey = '';
        if (config.primaryGrouping === 'date') {
          groupKey = new Date(record.recordedAt).toISOString().split('T')[0];
        } else if (config.primaryGrouping === 'sku') {
          groupKey = sku.productName;
        } else if (config.primaryGrouping === 'store') {
          const store = stores.find(s => s.id === record.storeId);
          groupKey = store ? store.storeName : 'Unknown Store';
        } else if (config.primaryGrouping === 'staff') {
          const user = users.find(u => u.id === record.recordedById);
          groupKey = user ? `${user.firstName} ${user.lastName}` : 'Unknown Staff';
        } else if (config.primaryGrouping === 'category') {
          groupKey = sku.category;
        }

        if (!groupedData[groupKey]) {
          groupedData[groupKey] = {
            totalQuantity: 0,
            transactionCount: 0,
            uniqueSkus: new Set(),
            uniqueStores: new Set(),
            uniqueStaff: new Set()
          };
        }

        groupedData[groupKey].totalQuantity += scannedSku.quantity;
        groupedData[groupKey].transactionCount += 1;
        groupedData[groupKey].uniqueSkus.add(sku.id);
        groupedData[groupKey].uniqueStores.add(record.storeId);
        groupedData[groupKey].uniqueStaff.add(record.recordedById);
      });
    });

    // Convert to array format
    return Object.entries(groupedData).map(([key, data]) => ({
      [config.primaryGrouping]: key,
      totalQuantity: data.totalQuantity,
      transactionCount: data.transactionCount,
      uniqueSkus: data.uniqueSkus.size,
      uniqueStores: data.uniqueStores.size,
      uniqueStaff: data.uniqueStaff.size,
      avgQuantity: data.transactionCount > 0 ? (data.totalQuantity / data.transactionCount).toFixed(2) : 0
    }));
  }

  function funExportToCSV(data, filename) {
    if (data.length === 0) {
      alert('No data to export.');
      return;
    }

    const headers = Object.keys(data[0]);
    const csvContent = [
      headers.join(','),
      ...data.map(row => headers.map(header => row[header]).join(','))
    ].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function funExportToJSON(data, filename) {
    const jsonContent = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  function funResetForm() {
    // Reset to default state
    currentState = {
      category: 'sales-summary',
      reportType: 'sales-by-date-range',
      dateRange: 'custom',
      startDate: sevenDaysAgo.toISOString().split('T')[0],
      endDate: today.toISOString().split('T')[0],
      primaryGrouping: '',
      secondaryGrouping: '',
      metrics: ['totalQuantity'],
      outputFormat: 'screen',
      sortMetric: 'totalQuantity',
      sortDirection: 'desc'
    };

    // Reset form elements
    elements.startDate.value = currentState.startDate;
    elements.endDate.value = currentState.endDate;
    
    // Reset grouping
    document.querySelectorAll('input[name="primaryGrouping"]').forEach(radio => {
      radio.checked = false;
    });
    document.getElementById('secondaryGrouping').value = '';

    // Reset metrics
    document.querySelectorAll('input[name="metrics"]').forEach(checkbox => {
      checkbox.checked = checkbox.value === 'totalQuantity';
    });

    // Reset output format
    document.querySelector('input[name="outputFormat"][value="screen"]').checked = true;

    // Reset sort options
    document.getElementById('sortMetric').value = 'totalQuantity';
    document.querySelector('input[name="sortDirection"][value="desc"]').checked = true;

    // Reset filters
    elements.skuFilter.selectedIndex = -1;
    elements.storeFilter.selectedIndex = -1;
    elements.staffFilter.selectedIndex = -1;
    elements.categoryFilter.selectedIndex = -1;
    document.getElementById('minQuantity').value = '';
    document.getElementById('maxQuantity').value = '';

    // Reset categories
    document.querySelectorAll('.report-category').forEach(btn => {
      btn.classList.remove('active', 'bg-teal-50', 'text-teal-700', 'border-l-3', 'border-teal-700');
      btn.classList.add('text-slate-700');
    });
    document.querySelector('.report-category[data-category="sales-summary"]').classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-l-3', 'border-teal-700');

    // Reset date quick selects
    document.querySelectorAll('.date-quick-select').forEach(btn => {
      btn.classList.remove('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');
    });
    document.querySelector('.date-quick-select[data-range="custom"]').classList.add('active', 'bg-teal-50', 'text-teal-700', 'border-teal-200');

    // Update displays
    funUpdateReportTypeOptions();
    funUpdateDateRangeDisplay();
    funUpdateReportPreview();

    // Clear saved configuration
    localStorage.removeItem('reportConfiguration');
  }
}
</script></body></html>